<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>8-Week Ruck & Strength Tracker</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
manifest.json
<style>
:root { --primary:#2563eb; --bg:#f8fafc; --card:#fff; --text:#1e293b; --border:#e2e8f0; --success:#10b981; }
body[data-theme="dark"] { --bg:#0f172a; --card:#1e293b; --text:#f8fafc; --border:#334155; }
body { font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif; background-color:var(--bg); color:var(--text); margin:0; padding:0; padding-bottom:80px; }
header { background:var(--primary); color:white; padding:1rem; position:sticky; top:0; z-index:100; display:flex; justify-content:space-between; align-items:center; }
button.toggle-theme { background:white; color:var(--primary); border:none; padding:6px 12px; border-radius:6px; font-weight:600; cursor:pointer; }
.view-container { display:none; max-width:600px; margin:0 auto; padding:1rem; }
.view-container.active { display:block; }
.home-grid { display:grid; grid-template-columns:1fr 1fr; gap:15px; margin-top:20px; }
.home-btn { background:var(--card); border:1px solid var(--border); padding:2rem; border-radius:12px; text-align:center; font-weight:700; font-size:1.1rem; cursor:pointer; box-shadow:0 1px 3px rgba(0,0,0,0.05); color:var(--text); transition:transform 0.1s; }
.home-btn:active { transform:scale(0.98); }
.controls { padding:1rem; display:flex; gap:10px; justify-content:space-between; align-items:center; background:white; border-bottom:1px solid var(--border); margin-bottom:1rem; }
select,input[type="date"] { padding:8px; border:1px solid var(--border); border-radius:6px; font-size:14px; }
.summary-dashboard { display:grid; grid-template-columns:repeat(4,1fr); gap:10px; margin-bottom:15px; }
.summary-card { background:var(--card); border:1px solid var(--border); border-radius:8px; padding:8px; text-align:center; font-size:0.8rem; color:var(--text); }
.summary-progress { height:6px; background:#e2e8f0; border-radius:3px; overflow:hidden; margin-top:4px; }
.summary-fill { height:100%; background:var(--success); width:0%; }
.exercise-card { background:var(--card); border-radius:12px; padding:1rem; margin-bottom:1rem; box-shadow:0 1px 3px rgba(0,0,0,0.05); border:1px solid var(--border); color:var(--text); }
.exercise-card.completed { border-left:5px solid var(--success); background:#f0fdf4; }
body[data-theme="dark"] .exercise-card.completed { background: #064e3b; }
.exercise-header { display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:0.5rem; }
.exercise-name { font-weight:700; font-size:1.1rem; }
.input-group { margin-top:10px; display:flex; gap:10px; }
input[type="text"] { width:100%; padding:8px; border:1px solid var(--border); border-radius:6px; font-size:14px; background:var(--bg); color:var(--text); }
.nav-bar { position:fixed; bottom:0; left:0; right:0; background:var(--card); border-top:1px solid var(--border); padding:10px; display:flex; justify-content:space-around; z-index:200; }
button.nav-btn { background:transparent; color:var(--text); border:none; padding:8px; font-size:0.8rem; display:flex; flex-direction:column; align-items:center; cursor:pointer; }
button.nav-btn.active { color:var(--primary); font-weight:bold; }
.back-btn { background:none; border:none; color:white; font-size:1.2rem; cursor:pointer; margin-right:10px; padding: 10px; }

.prev-val { font-size: 0.75rem; color: var(--primary); background: #eff6ff; padding: 2px 6px; border-radius: 4px; cursor: pointer; margin-left: 5px; border: 1px solid #bfdbfe; white-space: nowrap; }
.prev-val:active { background: #dbeafe; }
body[data-theme="dark"] .prev-val { background: #1e3a8a; border-color: #2563eb; color: #93c5fd; }

/* Mobile Optimizations */
@media (min-width: 600px) {
    .charts-grid { grid-template-columns: 1fr 1fr; }
}
@media (max-width: 599px) {
    .charts-grid { grid-template-columns: 1fr; }
    .home-grid { grid-template-columns: 1fr; }
    .summary-dashboard { grid-template-columns: repeat(4, 1fr); }
    /* Ensure inputs don't zoom on iOS */
    select, input[type="text"], input[type="date"] { font-size: 16px !important; }
}
</style>
</head>
<body>

<header>
    <div style="display:flex;align-items:center;">
        <button id="header-back-btn" class="back-btn" onclick="navigateTo('home')" style="display:none;">‚Üê</button>
        <h1 id="app-title" style="font-size:1.2rem;margin:0;">Training Tracker</h1>
    </div>
</header>

<div id="view-home" class="view-container">
    <div class="home-grid">
        <div class="home-btn" onclick="navigateTo('workout')">üèãÔ∏è Workout</div>
        <div class="home-btn" onclick="navigateTo('analytics')">üìä Analytics</div>
        <div class="home-btn" onclick="navigateTo('dashboard')">üìà Dashboard</div>
        <div class="home-btn" onclick="navigateTo('settings')">‚öôÔ∏è Settings</div>
    </div>
</div>

<div id="view-workout" class="view-container">
    <div class="controls">
        <div><label style="font-size:0.8rem;color:#64748b">Start Date:</label><input type="date" id="start-date-picker"></div>
        <div><label style="font-size:0.8rem;color:#64748b">Jump to:</label><select id="week-selector"><option value="1">Week 1</option><option value="2">Week 2</option><option value="3">Week 3</option><option value="4">Week 4</option><option value="5">Week 5</option><option value="6">Week 6</option><option value="7">Week 7</option><option value="8">Week 8</option></select></div>
    </div>
    <div class="subtitle" id="current-date-display" style="text-align:center;margin-bottom:1rem;font-weight:600;color:var(--text);">Today</div>
    
    <!-- Timer Section -->
    <div id="workout-timer" style="background:var(--card); padding:15px; border-radius:12px; border:1px solid var(--border); margin-bottom:20px; display:flex; justify-content:space-between; align-items:center; box-shadow:0 1px 3px rgba(0,0,0,0.05);">
        <div id="timer-display" style="font-size:2rem; font-weight:700; font-family:monospace; color:var(--text); letter-spacing:1px;">00:00</div>
        <div style="display:flex; gap:10px;">
            <button id="timer-btn-toggle" onclick="toggleTimer()" style="background:var(--primary); color:white; border:none; padding:10px 20px; border-radius:8px; cursor:pointer; font-weight:600; font-size:1rem; transition: background 0.2s;">Start</button>
            <button onclick="resetTimer()" style="background:transparent; color:#64748b; border:1px solid #cbd5e1; padding:10px 20px; border-radius:8px; cursor:pointer; font-weight:600; font-size:1rem; transition: background 0.2s;">Reset</button>
        </div>
    </div>

    <div id="workout-container"></div>
    <div style="display:flex;justify-content:space-between;margin-top:20px;">
        <button class="nav-btn" onclick="changeDay(-1)" style="background:var(--primary);color:white;border-radius:8px;padding:10px 20px;">‚Üê Prev</button>
        <button class="nav-btn" onclick="jumpToToday()" style="background:var(--primary);color:white;border-radius:8px;padding:10px 20px;">Today</button>
        <button class="nav-btn" onclick="changeDay(1)" style="background:var(--primary);color:white;border-radius:8px;padding:10px 20px;">Next ‚Üí</button>
    </div>
</div>

<div id="view-analytics" class="view-container">
    <h2>Analytics</h2>
    <div id="analytics-content"></div>
</div>

<div id="view-dashboard" class="view-container">
    <h2 id="dashboard-title">Weekly Progress</h2>
    <div class="summary-dashboard" id="summary-dashboard"></div>
    <div id="week-detail-view" style="display:none;">
        <button onclick="showDashboardOverview()" style="margin-bottom:15px;background:none;border:none;color:var(--primary);cursor:pointer;font-size:1rem;">‚Üê Back to Weeks</button>
        <div id="week-days-list"></div>
    </div>
    
    <h3 style="margin-top:30px;">Activity Calendar</h3>
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
        <button onclick="changeCalendarMonth(-1)" style="background:none;border:none;cursor:pointer;font-size:1.2rem;color:var(--text);">‚Üê</button>
        <span id="calendar-month-year" style="font-weight:bold;font-size:0.9rem;"></span>
        <button onclick="changeCalendarMonth(1)" style="background:none;border:none;cursor:pointer;font-size:1.2rem;color:var(--text);">‚Üí</button>
    </div>
    <div id="activity-calendar" style="display:grid;grid-template-columns:repeat(7, 1fr);gap:4px;"></div>
    
    <div style="margin-top:30px;background:var(--card);border:1px solid var(--border);border-radius:12px;overflow:hidden;">
        <div style="padding:15px;background:var(--primary);color:white;font-weight:bold;cursor:pointer;display:flex;justify-content:space-between;align-items:center;" onclick="toggleProgramOverview()">
            <span>Schedule Overview</span>
            <span id="overview-arrow">‚ñº</span>
        </div>
        <div id="program-overview-content" style="display:none;padding:15px;"></div>
    </div>

    <!-- Strength Program Overview -->
    <div style="margin-top:15px;background:var(--card);border:1px solid var(--border);border-radius:12px;overflow:hidden;">
        <div style="padding:15px;background:var(--primary);color:white;font-weight:bold;cursor:pointer;display:flex;justify-content:space-between;align-items:center;" onclick="toggleStrengthOverview()">
            <span>Strength Program Overview</span>
            <span id="strength-arrow">‚ñº</span>
        </div>
        <div id="strength-overview-content" style="display:none;padding:15px;"></div>
    </div>

    <!-- Nutrition Overview -->
    <div style="margin-top:15px;background:var(--card);border:1px solid var(--border);border-radius:12px;overflow:hidden;">
        <div style="padding:15px;background:var(--primary);color:white;font-weight:bold;cursor:pointer;display:flex;justify-content:space-between;align-items:center;" onclick="toggleNutritionOverview()">
            <span>Nutrition Overview</span>
            <span id="nutrition-arrow">‚ñº</span>
        </div>
        <div id="nutrition-overview-content" style="display:none;padding:15px;"></div>
    </div>
</div>

<div id="view-settings" class="view-container">
    <h2>Settings</h2>
    <div style="margin-bottom:20px;">
        <label style="display:block;margin-bottom:5px;font-weight:bold;">Your Name</label>
        <input type="text" id="user-name-input" placeholder="Enter your name" oninput="saveUserName(this.value)" style="width:100%;padding:10px;font-size:1rem;">
    </div>
    <div style="margin-bottom:20px;">
        <label style="display:block;margin-bottom:5px;font-weight:bold;">Bodyweight (lbs)</label>
        <input type="number" id="user-bw-input" placeholder="e.g. 185" oninput="saveBodyweight(this.value)" style="width:100%;padding:10px;font-size:1rem;">
    </div>
    <div style="margin-bottom:20px;">
        <label style="display:block;margin-bottom:5px;font-weight:bold;">Gender</label>
        <select id="user-gender-select" onchange="saveGender(this.value)" style="width:100%;padding:10px;font-size:1rem;">
            <option value="male">Male</option>
            <option value="female">Female</option>
        </select>
    </div>
    <div class="home-btn" onclick="toggleTheme()" style="margin-bottom:10px;">Toggle Dark Mode</div>
    <div class="home-btn" onclick="exportNotes()" style="margin-bottom:10px;">Export Notes</div>
    <div class="home-btn" onclick="resetData()" style="background:#ef4444;color:white;margin-top:20px;">‚ö†Ô∏è Reset All Data</div>
</div>

<script>
// Full workoutData array (all 8 weeks) ‚Äî explicit plan (no shorthand)
const workoutData = [];

function addItem(w, d, focus, ex, defaultSets, defaultReps, defaultLoad, defaultNote = "") {
    workoutData.push({
        w,
        d,
        focus,
        ex,
        defaultSets,
        defaultReps,
        defaultLoad,
        defaultNote
    });
}

function addUpperStrength(w, benchLoad, ohpLoad, extraNote = "") {
    const focus = "Upper Strength + Posture";
    addItem(w, 1, focus, "Bench Press", 4, "5‚Äì8", benchLoad, "Work sets. Keep 1‚Äì2 reps in reserve; strict setup and bracing." + (extraNote ? ` ${extraNote}` : ""));
    addItem(w, 1, focus, "Pull-ups", 4, "4‚Äì8", "BW", "Band-assist if needed. Use full hang + controlled tempo. Weighted if able (Weeks 5‚Äì7).");
    addItem(w, 1, focus, "Barbell Row", 4, "6‚Äì8", "Moderate", "Moderate, strict; no heaving. Keep torso angle consistent.");
    addItem(w, 1, focus, "Standing OHP", 3, "6‚Äì8", ohpLoad, "Standing. Pristine form; no backbend.");
    addItem(w, 1, focus, "Triceps Pushdown", 3, "10‚Äì12", "Moderate", "Control the eccentric; full lockout.");
    addItem(w, 1, focus, "DB Curls", 3, "10‚Äì12", "Moderate", "No swinging; full ROM.");

    // Posture/core finisher
    addItem(w, 1, focus, "Band Pull-Aparts", 3, "15‚Äì20", "-", "Posture finisher. Keep ribs down; squeeze mid-back.");
    addItem(w, 1, focus, "Wall Slides", 3, "10‚Äì12", "-", "Posture finisher. Slow reps; keep wrists/elbows tracking.");
    addItem(w, 1, focus, "Bird-Dog", 3, "8/side", "-", "Core/posture finisher. Avoid low-back rotation; reach long.");
    addItem(w, 1, focus, "Dead Bug", 3, "8/side", "-", "Core finisher. Keep low back gently pressed down.");
}

function addUpperHypertrophy(w, guidanceNote) {
    const focus = "Upper Hypertrophy + Posture";
    addItem(w, 4, focus, "Incline DB Bench", 3, "8‚Äì12", "Moderate", guidanceNote);
    addItem(w, 4, focus, "1-Arm DB Row", 3, "8‚Äì12/side", "Moderate", "Control the stretch; pull to hip. " + guidanceNote);
    addItem(w, 4, focus, "DB Shoulder Press", 3, "8‚Äì12", "Moderate", "Stop 1‚Äì2 reps shy of failure. " + guidanceNote);
    addItem(w, 4, focus, "Lateral Raises", 3, "12‚Äì15", "Light‚ÄìModerate", "Smooth reps; avoid traps taking over. " + guidanceNote);
    addItem(w, 4, focus, "Face Pulls", 3, "12‚Äì15", "Light‚ÄìModerate", "Elbows high; squeeze upper back. " + guidanceNote);
    addItem(w, 4, focus, "Hammer Curls", 3, "10‚Äì12", "Moderate", "2‚Äì3 sets is fine. " + guidanceNote);

    // Posture
    addItem(w, 4, focus, "Band Pull-Aparts", 3, "15‚Äì20", "-", "Posture work (5‚Äì10 min total).");
    addItem(w, 4, focus, "Wall Slides", 3, "10‚Äì12", "-", "Posture work (5‚Äì10 min total).");
}

function addLowerStrength(w, frontSquatLoad, trapBarLoad, calfSets, extraNote = "", focusTitle = "Lower Strength + Core") {
    const focus = focusTitle;
    addItem(w, 3, focus, "Front Squat", 4, "5‚Äì8", frontSquatLoad, "Light‚Äìmoderate; prioritize bracing and depth you can own." + (extraNote ? ` ${extraNote}` : ""));
    addItem(w, 3, focus, "Trap-Bar Deadlift", 3, "5‚Äì6", trapBarLoad, "Submaximal; perfect form. Stop early if back feels off." + (extraNote ? ` ${extraNote}` : ""));
    addItem(w, 3, focus, "Reverse Lunges (DB)", 3, "8/leg", "Moderate", "Controlled step; keep torso stacked.");
    addItem(w, 3, focus, "Hip Thrust / Glute Bridge", 3, "10‚Äì12", "Moderate", "Full hip lockout; pause at top.");
    addItem(w, 3, focus, "Standing Calf Raises", calfSets, "10‚Äì15", "Moderate", "Full stretch at bottom, pause at top.");

    // Core/posture
    addItem(w, 3, focus, "Plank", 3, "20‚Äì30 sec", "BW", "Brace hard; breathe behind the brace.");
    addItem(w, 3, focus, "Side Plank", 2, "20 sec/side", "BW", "Stack shoulders/hips; no sagging.");
    addItem(w, 3, focus, "Chest Stretch (Doorway)", 2, "30 sec/side", "-", "Easy stretch; no pain.");
}

function addLowerStrengthHeavier(w, frontSquatLoad, trapBarLoad, calfSets, extraNote = "", focusTitle = "Lower Strength + Core") {
    const focus = focusTitle;
    addItem(w, 3, focus, "Front Squat", 4, "4‚Äì6", frontSquatLoad, "Heavier strength work; keep form pristine and stop with reps in reserve." + (extraNote ? ` ${extraNote}` : ""));
    addItem(w, 3, focus, "Trap-Bar Deadlift", 3, "4‚Äì6", trapBarLoad, "Heavier but controlled; perfect form. Stop early if back feels off." + (extraNote ? ` ${extraNote}` : ""));
    addItem(w, 3, focus, "Reverse Lunges (DB)", 3, "8/leg", "Moderate", "Controlled step; keep torso stacked.");
    addItem(w, 3, focus, "Hip Thrust / Glute Bridge", 3, "8‚Äì10", "Moderate", "Full hip lockout; pause at top.");
    addItem(w, 3, focus, "Standing Calf Raises", calfSets, "10‚Äì12", "Moderate", "Full stretch at bottom, pause at top.");

    // Core/posture
    addItem(w, 3, focus, "Plank", 3, "20‚Äì30 sec", "BW", "Brace hard; breathe behind the brace.");
    addItem(w, 3, focus, "Side Plank", 2, "20 sec/side", "BW", "Stack shoulders/hips; no sagging.");
    addItem(w, 3, focus, "Chest Stretch (Doorway)", 2, "30 sec/side", "-", "Easy stretch; no pain.");
}

function addFullBody(w, trapBarLoad, squatReps, frontSquatLoadForSat = "Moderate", optionalRuckPaceNote) {
    const focus = "Full Body + Optional Easy Ruck";
    addItem(w, 6, focus, "Trap-Bar Deadlift", 3, "5‚Äì6", trapBarLoad, "Moderate and crisp reps; no grinders.");
    addItem(w, 6, focus, "Front or Goblet Squat", 3, squatReps, frontSquatLoadForSat, "Choose front or goblet; keep it moderate.");
    addItem(w, 6, focus, "Pull-ups / Chin-ups", 3, "6‚Äì10", "BW", "Leave 1‚Äì2 reps in reserve; band-assist if needed.");
    addItem(w, 6, focus, "DB Bench", 3, "8‚Äì10", "Moderate", "Smooth reps; stop shy of failure.");
    addItem(w, 6, focus, "KB Swings", 3, "12‚Äì15", "Light‚ÄìModerate", "Only if tolerated. Snap hips; neutral spine.");

    // Core/posture
    addItem(w, 6, focus, "Bird-Dog", 3, "8/side", "-", "Core/posture. Slow and controlled.");
    addItem(w, 6, focus, "Dead Bug", 3, "8/side", "-", "Core. Keep low back controlled.");

    // Optional ruck
    addItem(w, 6, "Optional Ruck", "Ruck March", 1, "1‚Äì2 miles", "25 lb", `Optional. Very easy. ${optionalRuckPaceNote}`);
}

function addRecoveryDay(w, sundayNote) {
    const focus = "Recovery";
    addItem(w, 7, focus, "Easy Walk", 1, "20‚Äì40 minutes", "-", "Keep it easy; focus on posture and nasal breathing.");
    addItem(w, 7, focus, "Stretching", 1, "10‚Äì15 minutes", "-", "Hip flexors, hamstrings, calves, chest. Gentle, not aggressive.");
    if (sundayNote) {
        addItem(w, 7, focus, "Notes", 1, "-", "-", sundayNote);
    }
}

// =========================
// Week 1
// =========================
addUpperStrength(1, "180 lb", "95 lb");
addItem(1, 2, "Ruck (short)", "Ruck March", 1, "3 miles", "25 lb", "Target pace: 15:45‚Äì16:30/mi (easy‚Äìmoderate). Focus on posture.");
addLowerStrength(1, "~175 lb", "235 lb", 3, "", "Lower Strength (S1-friendly) + Core");
addUpperHypertrophy(1, "Week 1: pick loads you can control for the full rep range.");
addItem(1, 5, "Ruck (long)", "Ruck March", 1, "5 miles", "25 lb", "Target pace: 15:45‚Äì16:30/mi (steady). Nasal breathing if possible.");
addFullBody(1, "235 lb", "8‚Äì10", "Moderate", "Target pace: 16:30‚Äì17:30/mi.");
addRecoveryDay(1, "");

// =========================
// Week 2
// =========================
addUpperStrength(2, "185 lb", "100 lb");
addItem(2, 2, "Ruck (short)", "Ruck March", 1, "3.5 miles", "25 lb", "Target pace: 15:30‚Äì16:15/mi.");
addLowerStrength(2, "~180 lb", "240 lb", 3, "", "Lower Strength + Core");
addUpperHypertrophy(2, "Week 2: same exercises as Week 1. Nudge DB loads up if all sets were easy.");
addItem(2, 5, "Ruck (long)", "Ruck March", 1, "6 miles", "25 lb", "Target pace: 15:30‚Äì16:15/mi.");
addFullBody(2, "240 lb", "8‚Äì10", "Moderate", "Target pace: 16:30‚Äì17:30/mi.");
addRecoveryDay(2, "");

// =========================
// Week 3
// =========================
addUpperStrength(3, "190 lb", "100‚Äì105 lb");
addItem(
    3,
    2,
    "Ruck (short/pace work)",
    "Ruck March",
    1,
    "5 miles",
    "25 lb",
    "Target pace overall: 15:00‚Äì15:45/mi. Build as: 5 √ó 6 min near 14:30‚Äì15:00/mi / 4 min easy between, plus warm-up and cool-down."
);
addLowerStrength(3, "~185 lb", "250 lb", 3, "", "Lower Strength + Core");
addUpperHypertrophy(3, "Week 3: same structure. Slightly heavier if recovering well.");
addItem(3, 5, "Ruck (long)", "Ruck March", 1, "7 miles", "25 lb", "Target pace: 15:00‚Äì15:45/mi.");
addFullBody(3, "250 lb", "8‚Äì10", "Moderate", "Optional if feeling fresh. Target pace: 16:00‚Äì17:00/mi.");
addRecoveryDay(3, "");

// =========================
// Week 4
// =========================
addUpperStrength(4, "200 lb", "105 lb");
addItem(4, 2, "Ruck (short)", "Ruck March", 1, "5‚Äì6 miles", "25 lb", "Target pace: 14:45‚Äì15:30/mi.");
addLowerStrength(4, "~190‚Äì195 lb", "255‚Äì260 lb", 3, "", "Lower Strength + Core");
addUpperHypertrophy(4, "Week 4: same structure. Stay 1‚Äì2 reps shy of failure.");
addItem(4, 5, "Ruck (long)", "Ruck March", 1, "8‚Äì9 miles", "25 lb", "Target pace: 14:45‚Äì15:30/mi. Big jump week‚Äîkeep mechanics clean.");
addFullBody(4, "255‚Äì260 lb", "8‚Äì10", "Moderate", "Target pace: 16:00‚Äì17:00/mi.");
addRecoveryDay(4, "");

// =========================
// Week 5
// =========================
// Mon ‚Äì Upper Strength (heavier) + Posture
addItem(5, 1, "Upper Strength (heavier) + Posture", "Bench Press", 4, "4‚Äì6", "200 lb", "Heavier week. Keep 1‚Äì2 reps in reserve; strict setup and bracing.");
addItem(5, 1, "Upper Strength (heavier) + Posture", "Pull-ups", 4, "4‚Äì6", "BW/Weighted", "Weighted if possible. Band-assist if needed. Full hang + controlled tempo.");
addItem(5, 1, "Upper Strength (heavier) + Posture", "Barbell Row", 4, "6‚Äì8", "Moderate", "Strict rows; no heaving.");
addItem(5, 1, "Upper Strength (heavier) + Posture", "Standing OHP", 3, "5‚Äì7", "105 lb", "Pristine form; no backbend.");
addItem(5, 1, "Upper Strength (heavier) + Posture", "Close-Grip Bench or Dips", 3, "6‚Äì8", "Moderate", "Pick one. Controlled reps; shoulder-friendly ROM.");
addItem(5, 1, "Upper Strength (heavier) + Posture", "EZ/BB Curls", 3, "8‚Äì10", "Moderate", "Strict curls; don‚Äôt rock.");
addItem(5, 1, "Upper Strength (heavier) + Posture", "Band Pull-Aparts", 3, "15‚Äì20", "-", "Posture finisher. Keep ribs down; squeeze mid-back.");
addItem(5, 1, "Upper Strength (heavier) + Posture", "Wall Slides", 3, "10‚Äì12", "-", "Posture finisher. Slow reps; keep wrists/elbows tracking.");
addItem(5, 1, "Upper Strength (heavier) + Posture", "Bird-Dog", 3, "8/side", "-", "Core/posture finisher. Avoid low-back rotation; reach long.");
addItem(5, 1, "Upper Strength (heavier) + Posture", "Dead Bug", 3, "8/side", "-", "Core finisher. Keep low back gently pressed down.");

addItem(5, 2, "Ruck (threshold)", "Ruck March", 1, "5 miles", "25 lb", "Target pace: 14:30‚Äì15:00/mi (close to event pace but controlled).");
addLowerStrengthHeavier(5, "~195 lb", "255‚Äì260 lb", 4, "", "Lower Strength (heavier) + Core");
addUpperHypertrophy(5, "Week 5: 3‚Äì4√ó8‚Äì12 for chest/back/shoulders, 2‚Äì3√ó10‚Äì12 for arms. Keep posture work (pull-aparts + wall slides).");
addItem(5, 5, "Ruck (long)", "Ruck March", 1, "9‚Äì10 miles", "25 lb", "Target pace: 14:45‚Äì15:15/mi.");
// Week 5 Saturday has front squat specifically 3√ó6‚Äì8 @ ~185‚Äì190 and optional ruck
addItem(5, 6, "Full Body + Optional Easy Ruck", "Trap-Bar Deadlift", 3, "4‚Äì6", "255‚Äì260 lb", "Heavier-ish but still crisp. No grinders.");
addItem(5, 6, "Full Body + Optional Easy Ruck", "Front Squat", 3, "6‚Äì8", "~185‚Äì190 lb", "Moderate; own every rep.");
addItem(5, 6, "Full Body + Optional Easy Ruck", "Pull-ups", 3, "6‚Äì10", "BW", "Band-assist if needed.");
addItem(5, 6, "Full Body + Optional Easy Ruck", "DB Bench", 3, "8‚Äì10", "Moderate", "Smooth reps; stop shy of failure.");
addItem(5, 6, "Full Body + Optional Easy Ruck", "KB Swings", 3, "12‚Äì15", "Light‚ÄìModerate", "Only if tolerated. Neutral spine.");
addItem(5, 6, "Full Body + Optional Easy Ruck", "Bird-Dog", 3, "8/side", "-", "Core/posture.");
addItem(5, 6, "Full Body + Optional Easy Ruck", "Dead Bug", 3, "8/side", "-", "Core.");
addItem(5, 6, "Optional Ruck", "Ruck March", 1, "1‚Äì2 miles", "25 lb", "Optional. Very easy. Target pace: 16:00‚Äì17:00/mi.");
addRecoveryDay(5, "");

// =========================
// Week 6
// =========================
// Mon ‚Äì Upper Strength + Posture
addItem(6, 1, "Upper Strength + Posture", "Bench Press", 4, "4‚Äì6", "205 lb", "Heavier strength work. Keep 1‚Äì2 reps in reserve; strict setup.");
addItem(6, 1, "Upper Strength + Posture", "Pull-ups", 4, "4‚Äì6", "BW/Weighted", "Weighted if able. Band-assist if needed. Full ROM.");
addItem(6, 1, "Upper Strength + Posture", "Barbell Row", 4, "6‚Äì8", "Moderate", "Strict rows; no heaving.");
addItem(6, 1, "Upper Strength + Posture", "Standing OHP", 3, "5‚Äì7", "110 lb", "Pristine form; no backbend.");
addItem(6, 1, "Upper Strength + Posture", "Close-Grip Bench or Dips", 3, "6‚Äì8", "Moderate", "Shoulder-friendly ROM; stop 1‚Äì2 reps short of failure.");
addItem(6, 1, "Upper Strength + Posture", "EZ/BB Curls", 3, "8‚Äì10", "Moderate", "Strict reps.");
addItem(6, 1, "Upper Strength + Posture", "Band Pull-Aparts", 3, "15‚Äì20", "-", "Posture finisher.");
addItem(6, 1, "Upper Strength + Posture", "Wall Slides", 3, "10‚Äì12", "-", "Posture finisher.");
addItem(6, 1, "Upper Strength + Posture", "Bird-Dog", 3, "8/side", "-", "Core/posture finisher.");
addItem(6, 1, "Upper Strength + Posture", "Dead Bug", 3, "8/side", "-", "Core finisher.");
addItem(6, 2, "Ruck (threshold)", "Ruck March", 1, "5‚Äì6 miles", "25 lb", "Target pace: 14:30‚Äì15:00/mi (hold steady pace).");
addLowerStrengthHeavier(6, "~200 lb", "270 lb", 4, "Only use 270 if back feels good; otherwise stay lighter.", "Lower Strength + Core");
addUpperHypertrophy(6, "Week 6: same pattern as prior weeks.");
addItem(6, 5, "Ruck (long rehearsal)", "Ruck March", 1, "10‚Äì12 miles", "25 lb", "Target pace: 14:45‚Äì15:15/mi. Practice event hydration/nutrition.");
addItem(6, 6, "Full Body (lighter) + Optional Ruck", "Trap-Bar Deadlift", 3, "4‚Äì6", "~260 lb", "Lighter day: crisp reps only.");
addItem(6, 6, "Full Body (lighter) + Optional Ruck", "Front Squat", 3, "6‚Äì8", "~185‚Äì190 lb", "Moderate.");
addItem(6, 6, "Full Body (lighter) + Optional Ruck", "Pull-ups", 3, "6‚Äì10", "BW", "Stop well before failure.");
addItem(6, 6, "Full Body (lighter) + Optional Ruck", "DB Bench", 3, "8‚Äì10", "Moderate", "Light/moderate.");
addItem(6, 6, "Full Body (lighter) + Optional Ruck", "Core / Light Accessories", 1, "-", "-", "Keep it easy: quick core/posture only.");
addItem(6, 6, "Optional Ruck", "Ruck March", 1, "1‚Äì2 miles", "25 lb", "Optional. Very easy. Target pace: 16:00‚Äì17:00/mi.");
addRecoveryDay(6, "");

// =========================
// Week 7
// =========================
// Mon ‚Äì Upper Strength + Posture
addItem(7, 1, "Upper Strength + Posture", "Bench Press", 4, "4‚Äì6", "210 lb", "Heavy but controlled. Keep 1‚Äì2 reps in reserve; no grinders.");
addItem(7, 1, "Upper Strength + Posture", "Pull-ups", 4, "4‚Äì6", "BW/Weighted", "Weighted if possible. Band-assist if needed. Full ROM.");
addItem(7, 1, "Upper Strength + Posture", "Barbell Row", 4, "6‚Äì8", "Moderate", "Strict rows; no heaving.");
addItem(7, 1, "Upper Strength + Posture", "Standing OHP", 3, "4‚Äì6", "110‚Äì115 lb", "Only with pristine form; no backbend.");
addItem(7, 1, "Upper Strength + Posture", "Close-Grip Bench or Dips", 3, "6‚Äì8", "Moderate", "Controlled reps.");
addItem(7, 1, "Upper Strength + Posture", "EZ/BB Curls", 3, "8‚Äì10", "Moderate", "Strict.");
addItem(7, 1, "Upper Strength + Posture", "Band Pull-Aparts", 3, "15‚Äì20", "-", "Posture finisher.");
addItem(7, 1, "Upper Strength + Posture", "Wall Slides", 3, "10‚Äì12", "-", "Posture finisher.");
addItem(7, 1, "Upper Strength + Posture", "Bird-Dog", 3, "8/side", "-", "Core/posture finisher.");
addItem(7, 1, "Upper Strength + Posture", "Dead Bug", 3, "8/side", "-", "Core finisher.");
addItem(7, 2, "Ruck (pace)", "Ruck March", 1, "6 miles", "25 lb", "Target pace: 14:15‚Äì14:45/mi (slightly faster than goal pace for segments).");
addLowerStrengthHeavier(7, "~205 lb", "~270 lb", 4, "Stay at Week 6 load if back complains.", "Lower Strength + Core");
addUpperHypertrophy(7, "Week 7: moderate. Keep volume but avoid failure‚Äîthink ‚Äúsolid work,‚Äù not ‚Äúdestroyed.‚Äù");
addItem(7, 5, "Long Ruck Peak", "Ruck March", 1, "14‚Äì15 miles", "25 lb", "Target pace: 14:45‚Äì15:15/mi. Simulate event nutrition/hydration.");
addItem(7, 6, "Full Body (very moderate) + No or Tiny Ruck", "Trap-Bar Deadlift", 3, "3‚Äì5", "~260‚Äì270 lb", "Very moderate. Stop far from failure.");
addItem(7, 6, "Full Body (very moderate) + No or Tiny Ruck", "Front Squat", 3, "6", "~185 lb", "Moderate; crisp reps.");
addItem(7, 6, "Full Body (very moderate) + No or Tiny Ruck", "Pull-ups", 3, "6‚Äì8", "BW", "2‚Äì3 sets is fine. Keep it easy.");
addItem(7, 6, "Full Body (very moderate) + No or Tiny Ruck", "Light DB Bench", 3, "8‚Äì10", "Light", "2‚Äì3 sets is fine. Keep it easy.");
addItem(7, 6, "Full Body (very moderate) + No or Tiny Ruck", "Quick Core/Posture", 1, "-", "-", "Quick finisher only; don‚Äôt accumulate fatigue.");
addItem(7, 6, "Optional Ruck", "Ruck March", 1, "0‚Äì1 mile", "25 lb", "Optional: skip ruck or do at most 1 easy mile for stiffness.");
addRecoveryDay(7, "Extra mobility and sleep; no hard work.");

// =========================
// Week 8 (taper into March 5)
// =========================
// Monday deload = Day 1
addItem(8, 1, "Upper Deload", "Bench Press", 3, "5", "175 lb", "Deload: stop well before failure.");
addItem(8, 1, "Upper Deload", "Pull-ups", 3, "easy sets", "BW", "Stop well before failure.");
addItem(8, 1, "Upper Deload", "Standing OHP", 3, "6", "85‚Äì95 lb", "Very controlled. Deload.");
addItem(8, 1, "Upper Deload", "Very Light Rows", 2, "10‚Äì12", "Light", "Keep it easy (any row variation).");
addItem(8, 1, "Upper Deload", "Very Light Triceps", 2, "10‚Äì12", "Light", "Keep it easy.");
addItem(8, 1, "Upper Deload", "Very Light Curls", 2, "10‚Äì12", "Light", "Keep it easy.");
addItem(8, 1, "Upper Deload", "Band Pull-Aparts", 2, "15‚Äì20", "-", "Short posture set.");
addItem(8, 1, "Upper Deload", "Wall Slides", 2, "10‚Äì12", "-", "Short posture set.");
addItem(8, 1, "Upper Deload", "Chest Stretch (Doorway)", 2, "30 sec/side", "-", "Short posture set.");

addItem(8, 2, "Ruck (light)", "Ruck March", 1, "4‚Äì5 miles", "25 lb", "Target pace: 15:00‚Äì15:45/mi (smooth and relaxed).");

addItem(8, 3, "Lower Deload", "Front Squat", 3, "5", "~165‚Äì175 lb", "Deload: crisp reps, stop early.");
addItem(8, 3, "Lower Deload", "Trap-Bar Deadlift", 3, "4‚Äì5", "~225‚Äì235 lb", "Deload: perfect form; no grinders.");
addItem(8, 3, "Lower Deload", "Light Reverse Lunges", 2, "8/leg", "Light", "Easy and controlled.");
addItem(8, 3, "Lower Deload", "Standing Calf Raises", 2, "10‚Äì12", "Light‚ÄìModerate", "Easy volume.");
addItem(8, 3, "Lower Deload", "Bird-Dog", 2, "8/side", "-", "Easy core.");
addItem(8, 3, "Lower Deload", "Dead Bug", 2, "8/side", "-", "Easy core.");

addItem(8, 4, "Upper Light", "Incline DB Bench", 2, "8‚Äì12", "Easy", "2‚Äì3 easy sets per movement; no strain.");
addItem(8, 4, "Upper Light", "1-Arm DB Row", 2, "8‚Äì12/side", "Easy", "2‚Äì3 easy sets per movement; no strain.");
addItem(8, 4, "Upper Light", "DB Shoulder Press", 2, "8‚Äì12", "Easy", "2‚Äì3 easy sets per movement; no strain.");
addItem(8, 4, "Upper Light", "Lateral Raises", 2, "10‚Äì15", "Easy", "2‚Äì3 easy sets per movement; no strain.");
addItem(8, 4, "Upper Light", "Face Pulls", 2, "10‚Äì15", "Easy", "2‚Äì3 easy sets per movement; no strain.");
addItem(8, 4, "Upper Light", "Band Pull-Aparts", 2, "15‚Äì20", "-", "Posture work 5‚Äì10 minutes.");
addItem(8, 4, "Upper Light", "Wall Slides", 2, "10‚Äì12", "-", "Posture work 5‚Äì10 minutes.");

addItem(8, 5, "Ruck (final tune-up)", "Ruck March", 1, "6‚Äì8 miles", "25 lb", "Target pace: 15:00‚Äì15:45/mi.");

addItem(8, 6, "Rest / Very Light", "Easy Walk", 1, "20‚Äì30 minutes", "-", "Easy walk only if you want; otherwise full rest.");
addItem(8, 6, "Rest / Very Light", "Stretching", 1, "10‚Äì15 minutes", "-", "Light stretching only.");

addItem(8, 7, "Event Week (leading into March 5)", "Easy Walk", 1, "20‚Äì30 minutes", "-", "Do 2‚Äì3 short easy walks this week; no rucks.");
addItem(8, 7, "Event Week (leading into March 5)", "Posture/Core", 1, "5‚Äì10 minutes", "-", "Light posture/core only (no strain).");
addItem(8, 7, "Event Week (leading into March 5)", "Sleep/Hydrate/Carbs", 1, "-", "-", "Sleep, hydrate, keep carbs and sodium up per your nutrition plan.");

// Helper to find exercise data from UID
function getExerciseFromUid(uid) {
    try {
        const parts = uid.split('-'); // w1-d1-i0
        const w = parseInt(parts[0].substring(1));
        const d = parseInt(parts[1].substring(1));
        const i = parseInt(parts[2].substring(1));
        const daysExercises = workoutData.filter(item => item.w === w && item.d === d);
        return daysExercises[i];
    } catch(e) {
        console.error("Error parsing UID", uid, e);
        return null;
    }
}

function getSets(uid, defaultSets, defaultReps, defaultLoad) {
    try {
        const saved = localStorage.getItem(uid + '_sets');
        if (saved) return JSON.parse(saved);
    } catch (e) {
        console.error("Error reading sets from LS", e);
    }
    
    // Generate defaults
    const sets = [];
    const count = defaultSets || 1; 
    for (let i = 0; i < count; i++) {
        sets.push({ reps: defaultReps || '-', load: defaultLoad || '-', done: false });
    }
    return sets;
}

// Helper to find previous workout data for an exercise
function getLastLog(exerciseName, currentW, currentD) {
    const history = workoutData.filter(item =>
        item.ex === exerciseName &&
        (item.w < currentW || (item.w === currentW && item.d < currentD))
    );
    history.sort((a, b) => {
        if (a.w !== b.w) return b.w - a.w;
        return b.d - a.d;
    });

    for (const item of history) {
        // Find uid
        const dayItems = workoutData.filter(i => i.w === item.w && i.d === item.d);
        const idx = dayItems.indexOf(item);
        const uid = `w${item.w}-d${item.d}-i${idx}`;
        const saved = localStorage.getItem(uid + '_sets');
        if (saved) return JSON.parse(saved);
    }
    return null;
}

// Navigation Logic
function navigateTo(view) {
    document.querySelectorAll('.view-container').forEach(el => el.classList.remove('active'));
    document.getElementById('view-' + view).classList.add('active');
    
    const backBtn = document.getElementById('header-back-btn');
    const titleEl = document.getElementById('app-title');
    const name = localStorage.getItem('userName');
    
    if (view === 'home') {
        backBtn.style.display = 'none';
        titleEl.textContent = 'Training Tracker';
    } else {
        backBtn.style.display = 'block';
        let viewName = view.charAt(0).toUpperCase() + view.slice(1);
        if (view === 'dashboard' && name) {
            viewName = `${name}'s Dashboard`;
        }
        titleEl.textContent = viewName;
    }

    if (view === 'workout') {
        renderWorkout();
    } else if (view === 'dashboard') {
        showDashboardOverview(); // Reset to overview when entering dashboard
        updateSummary();
    } else if (view === 'analytics') {
        renderAnalytics();
    }
}

// Chart instances management
const chartInstances = {};

// Analytics Logic
function renderAnalytics() {
    const container = document.getElementById('analytics-content');
    container.innerHTML = '';
    
    // Destroy existing charts to prevent canvas reuse errors
    Object.keys(chartInstances).forEach(key => {
        if(chartInstances[key]) {
            chartInstances[key].destroy();
            delete chartInstances[key];
        }
    });
    
    // Create canvas elements
    // Primary lifts for this program (used for analytics charts)
    const lifts = ['Bench Press', 'Front Squat', 'Trap-Bar Deadlift', 'Standing OHP'];
    
    // Container for lift charts
    const liftsContainer = document.createElement('div');
    liftsContainer.className = 'charts-grid';
    liftsContainer.style.display = 'grid';
    liftsContainer.style.gap = '10px';
    
    lifts.forEach(lift => {
        const wrapper = document.createElement('div');
        wrapper.className = 'summary-card';
        wrapper.style.padding = '10px';
        wrapper.innerHTML = `<div style="font-size:0.8rem;font-weight:bold;margin-bottom:5px;">${lift} (Est. 1RM)</div><canvas id="chart-${lift.replace(/\s/g,'')}"></canvas>`;
        liftsContainer.appendChild(wrapper);
    });
    
    // Container for Ruck Chart
    const ruckWrapper = document.createElement('div');
    ruckWrapper.className = 'summary-card';
    ruckWrapper.style.padding = '10px';
    ruckWrapper.style.marginTop = '15px';
    ruckWrapper.innerHTML = `<div style="font-size:0.9rem;font-weight:bold;margin-bottom:5px;">Rucking Volume (Miles)</div><canvas id="chart-ruck"></canvas>`;
    
    container.appendChild(liftsContainer);
    container.appendChild(ruckWrapper);
    
    // Standards Section
    const bw = parseFloat(localStorage.getItem('userBodyweight'));
    if (!isNaN(bw) && bw > 0) {
        const standardsContainer = document.createElement('div');
        standardsContainer.className = 'summary-card';
        standardsContainer.style.padding = '10px';
        standardsContainer.style.marginTop = '15px';
        
        standardsContainer.innerHTML = `<div style="font-size:0.9rem;font-weight:bold;margin-bottom:5px;">Strength Comparison (vs BW: ${bw}lb)</div>
        <div style="height:300px;"><canvas id="chart-standards"></canvas></div>
        <div style="font-size:0.7rem;color:#64748b;margin-top:5px;text-align:center;">Based on general strength standards multipliers</div>`;
        
        container.appendChild(standardsContainer);
    } else {
        const prompt = document.createElement('div');
        prompt.className = 'summary-card';
        prompt.style.padding = '15px';
        prompt.style.marginTop = '15px';
        prompt.style.textAlign = 'center';
        prompt.innerHTML = `<p>Enter your <strong>Bodyweight</strong> in Settings to see Strength Standards comparison.</p>
        <button onclick="navigateTo('settings')" style="background:var(--primary);color:white;border:none;padding:8px 16px;border-radius:6px;cursor:pointer;margin-top:5px;">Go to Settings</button>`;
        container.appendChild(prompt);
    }
    
    // Gather Data
    // We want to track progress over time. Let's group by Week.
    // Structure: { Week1: {Bench: 180, Squat: 225...}, Week2: ... }
    const weeklyMaxes = {};
    const currentMaxes = {}; // Latest best
    const weeklyRuck = {}; // { Week1: 5, Week2: 6... }
    
    for(let w=1; w<=8; w++) {
        weeklyMaxes[w] = {};
        weeklyRuck[w] = 0;
        lifts.forEach(l => weeklyMaxes[w][l] = 0);
    }
    
    lifts.forEach(l => currentMaxes[l] = 0);
    
    workoutData.forEach((item) => {
        // Construct UID
        const daysExercises = workoutData.filter(d => d.w === item.w && d.d === item.d);
        const index = daysExercises.indexOf(item);
        const uid = `w${item.w}-d${item.d}-i${index}`;
        const sets = getSets(uid, item.defaultSets, item.defaultReps, item.defaultLoad);
        
        // Rucking Logic
        if (item.ex === "Ruck March" && item.focus.includes("Ruck")) {
            // Check if done
            const isDone = sets.every(s => s.done);
            if (isDone) {
               // Try to parse miles from reps (e.g., "3 miles")
               // Default reps is string like "3 miles" or "3 + (w-1)..."
               // We need the ACTUAL saved value if edited, or default.
               // sets[0].reps should have it.
               const repStr = sets[0].reps.toLowerCase();
               const miles = parseFloat(repStr);
               if (!isNaN(miles)) {
                   weeklyRuck[item.w] += miles;
               }
            }
        }
        
        // Lift Logic
        if (lifts.includes(item.ex)) {
            sets.forEach(s => {
                if (s.done) {
                    const load = parseFloat(s.load);
                    const reps = parseFloat(s.reps);
                    if (!isNaN(load) && !isNaN(reps) && reps > 0) {
                        const e1rm = load * (1 + reps/30);
                        if (e1rm > weeklyMaxes[item.w][item.ex]) {
                            weeklyMaxes[item.w][item.ex] = e1rm;
                        }
                        if (e1rm > currentMaxes[item.ex]) {
                            currentMaxes[item.ex] = e1rm;
                        }
                    }
                }
            });
        }
    });
    
    // Render Standards Chart if BW exists
    if (!isNaN(bw) && bw > 0) {
        // Multipliers (Approximate male/female standards)
        const gender = localStorage.getItem('userGender') || 'male';
        
        let standards = {};
        
        // Approx multipliers; mapped to this program's main lifts.
        // Front Squat ~ Back Squat; Trap-Bar Deadlift ~ Deadlift; Standing OHP ~ OHP.
        if (gender === 'female') {
            standards = {
                'Bench Press': { beg: 0.5, int: 0.75, adv: 1.0 },
                'Front Squat': { beg: 0.75, int: 1.15, adv: 1.5 },
                'Trap-Bar Deadlift': { beg: 1.0, int: 1.25, adv: 1.75 },
                'Standing OHP': { beg: 0.35, int: 0.55, adv: 0.75 }
            };
        } else {
            standards = {
                'Bench Press': { beg: 0.75, int: 1.15, adv: 1.5 },
                'Front Squat': { beg: 1.0, int: 1.5, adv: 2.0 },
                'Trap-Bar Deadlift': { beg: 1.25, int: 1.75, adv: 2.25 },
                'Standing OHP': { beg: 0.5, int: 0.75, adv: 1.0 }
            };
        }
        
        const labels = lifts;
        const userVals = lifts.map(l => Math.round(currentMaxes[l]));
        const begVals = lifts.map(l => Math.round(bw * standards[l].beg));
        const intVals = lifts.map(l => Math.round(bw * standards[l].int));
        const advVals = lifts.map(l => Math.round(bw * standards[l].adv));
        
        chartInstances['chart-standards'] = new Chart(document.getElementById('chart-standards').getContext('2d'), {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [
                    { label: 'You', data: userVals, backgroundColor: '#2563eb', borderRadius: 4 },
                    { label: 'Beginner', data: begVals, backgroundColor: '#94a3b8', borderRadius: 4, hidden: true },
                    { label: 'Intermediate', data: intVals, backgroundColor: '#fbbf24', borderRadius: 4 },
                    { label: 'Advanced', data: advVals, backgroundColor: '#f87171', borderRadius: 4 }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: { y: { beginAtZero: true, title: {display:true, text:'Weight (lbs)'} } },
                plugins: {
                    legend: { position: 'bottom' },
                    title: { display: true, text: `Standards for ${gender.charAt(0).toUpperCase() + gender.slice(1)}` }
                }
            }
        });
    }
    
    // Render Lift Charts
    const weeksLabel = Array.from({length:8}, (_, i) => `W${i+1}`);
    
    lifts.forEach(lift => {
        const chartId = `chart-${lift.replace(/\s/g,'')}`;
        const ctx = document.getElementById(chartId).getContext('2d');
        const data = [];
        for(let w=1; w<=8; w++) {
            data.push(weeklyMaxes[w][lift] || 0); // 0 means no data for that week
        }
        
        chartInstances[chartId] = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: weeksLabel,
                datasets: [{
                    label: '1RM',
                    data: data,
                    backgroundColor: '#2563eb',
                    borderRadius: 4
                }]
            },
            options: {
                responsive: true,
                plugins: { legend: { display: false } },
                scales: {
                    x: { display: true, ticks: {font:{size:10}} },
                    y: { beginAtZero: false, display: true, ticks: {font:{size:10}} }
                }
            }
        });
    });
    
    // Render Ruck Chart
    const ruckCtx = document.getElementById('chart-ruck').getContext('2d');
    const ruckData = [];
    for(let w=1; w<=8; w++) {
        ruckData.push(weeklyRuck[w]);
    }
    
    chartInstances['chart-ruck'] = new Chart(ruckCtx, {
        type: 'line',
        data: {
            labels: weeksLabel,
            datasets: [{
                label: 'Miles',
                data: ruckData,
                borderColor: '#10b981',
                backgroundColor: 'rgba(16, 185, 129, 0.2)',
                fill: true,
                tension: 0.3
            }]
        },
        options: {
            responsive: true,
            plugins: { legend: { display: false } },
            scales: {
                y: { beginAtZero: true }
            }
        }
    });
}

function resetData() {
    if(confirm("Are you sure you want to delete all data? This cannot be undone.")) {
        localStorage.clear();
        location.reload();
    }
}

let currentWeek=1,currentDay=1,startDate=new Date();
function toggleTheme(){const body=document.body;const current=body.getAttribute('data-theme');if(current==='dark'){body.removeAttribute('data-theme');localStorage.setItem('theme','light');}else{body.setAttribute('data-theme','dark');localStorage.setItem('theme','dark');}}
if(localStorage.getItem('theme')==='dark'){document.body.setAttribute('data-theme','dark');}
function exportNotes(){let notes='Workout Notes:\\n';for(let i=0;i<localStorage.length;i++){const key=localStorage.key(i);if(key.endsWith('_note')){notes+=key+': '+localStorage.getItem(key)+'\\n';}}const blob=new Blob([notes],{type:'text/plain'});const url=URL.createObjectURL(blob);const a=document.createElement('a');a.href=url;a.download='ruck_notes.txt';a.click();URL.revokeObjectURL(url);}

function updateSummary(){
    const dashboard=document.getElementById('summary-dashboard');
    dashboard.innerHTML='';
    const counts={};
    for(let w=1;w<=8;w++) counts[w]={total:0,done:0};
    
    const dayIdx={};
    workoutData.forEach(item=>{
        if(item.w<1||item.w>8) return;
        const k=`${item.w}-${item.d}`;
        if(dayIdx[k]===undefined) dayIdx[k]=0;
        const idx=dayIdx[k]++;
        const uid=`w${item.w}-d${item.d}-i${idx}`;
        const sets = getSets(uid, item.defaultSets, item.defaultReps, item.defaultLoad);
        sets.forEach(s => {
            counts[item.w].total++;
            if(s.done) counts[item.w].done++;
        });
    });

    for(let w=1;w<=8;w++){
        const{total,done}=counts[w];
        const percent=total?Math.round((done/total)*100):0;
        const card=document.createElement('div');
        card.className='summary-card';
        card.style.cursor = 'pointer';
        card.onclick = () => showWeekDetail(w);
        card.innerHTML='Week '+w+'<div class="summary-progress"><div class="summary-fill" style="width:'+percent+'%"></div></div>'+percent+'%';
        dashboard.appendChild(card);
    }
    
    renderCalendar();
}

// Quotes
const quotes = [
    "Strength does not come from winning. Your struggles develop your strengths.",
    "The only bad workout is the one that didn't happen.",
    "Don't stop when you're tired. Stop when you're done.",
    "Your body can stand almost anything. It's your mind that you have to convince.",
    "The pain you feel today will be the strength you feel tomorrow.",
    "Discipline is doing what needs to be done, even if you don't want to do it."
];

function showGreeting() {
    const name = localStorage.getItem('userName') || 'Friend';
    const quote = quotes[Math.floor(Math.random() * quotes.length)];
    
    // Create Overlay
    const overlay = document.createElement('div');
    overlay.id = 'greeting-overlay';
    overlay.style.position = 'fixed';
    overlay.style.top = '0';
    overlay.style.left = '0';
    overlay.style.width = '100%';
    overlay.style.height = '100%';
    overlay.style.background = 'var(--bg)';
    overlay.style.color = 'var(--text)';
    overlay.style.zIndex = '1000';
    overlay.style.display = 'flex';
    overlay.style.flexDirection = 'column';
    overlay.style.justifyContent = 'center';
    overlay.style.alignItems = 'center';
    overlay.style.textAlign = 'center';
    overlay.style.padding = '20px';
    overlay.style.transition = 'opacity 0.5s ease';
    
    overlay.innerHTML = `
        <h1 style="font-size:2rem;margin-bottom:20px;">Welcome, ${name}</h1>
        <p style="font-size:1.2rem;font-style:italic;max-width:500px;line-height:1.5;">"${quote}"</p>
        <button onclick="closeGreeting()" style="margin-top:40px;padding:10px 25px;background:var(--primary);color:white;border:none;border-radius:8px;font-size:1rem;cursor:pointer;">Let's Go</button>
    `;
    
    document.body.appendChild(overlay);
}

function closeGreeting() {
    const overlay = document.getElementById('greeting-overlay');
    if(overlay) {
        overlay.style.opacity = '0';
        setTimeout(() => overlay.remove(), 500);
    }
}

function saveUserName(name) {
    localStorage.setItem('userName', name);
    updateHeaderName();
}

function saveBodyweight(bw) {
    localStorage.setItem('userBodyweight', bw);
    // Refresh analytics if view is active
    if(document.getElementById('view-analytics').classList.contains('active')) {
        renderAnalytics();
    }
}

function saveGender(gender) {
    localStorage.setItem('userGender', gender);
    // Refresh analytics if view is active
    if(document.getElementById('view-analytics').classList.contains('active')) {
        renderAnalytics();
    }
}

function updateHeaderName() {
    const name = localStorage.getItem('userName');
    const titleEl = document.getElementById('app-title');
    // Only update if on Dashboard or Home, otherwise keep view title
    // Actually, user asked for name at top of main screen.
    // Let's modify navigateTo to handle title updates dynamiclly.
    if(name && document.getElementById('view-dashboard').classList.contains('active')) {
         titleEl.textContent = `Dashboard - ${name}`;
    }
}

let calDate = new Date();

function changeCalendarMonth(offset) {
    calDate.setMonth(calDate.getMonth() + offset);
    renderCalendar();
}

function renderCalendar() {
    const calContainer = document.getElementById('activity-calendar');
    const headerEl = document.getElementById('calendar-month-year');
    calContainer.innerHTML = '';
    
    // Set Header
    const monthNames = ["January","February","March","April","May","June","July","August","September","October","November","December"];
    headerEl.textContent = `${monthNames[calDate.getMonth()]} ${calDate.getFullYear()}`;
    
    // Calculate Grid
    // First day of current month
    const firstDay = new Date(calDate.getFullYear(), calDate.getMonth(), 1);
    // Number of days in current month
    const lastDay = new Date(calDate.getFullYear(), calDate.getMonth() + 1, 0);
    const numDays = lastDay.getDate();
    
    // Start offset (Day of week: 0=Sun, 1=Mon...)
    // If we want Monday start, we adjust. Let's assume standard Sunday start for calendar grid visualization
    const startOffset = firstDay.getDay(); 
    
    // Find completion dates
    const completedDates = new Set();
    for(let i=0; i<localStorage.length; i++) {
        const key = localStorage.key(i);
        if(key.startsWith('completion_date_')) {
            completedDates.add(localStorage.getItem(key));
        }
    }
    
    // Day Headers (S M T W T F S)
    const dayHeaders = ['S','M','T','W','T','F','S'];
    dayHeaders.forEach(h => {
        const hEl = document.createElement('div');
        hEl.style.textAlign = 'center';
        hEl.style.fontSize = '0.7rem';
        hEl.style.fontWeight = 'bold';
        hEl.style.color = '#64748b';
        hEl.textContent = h;
        calContainer.appendChild(hEl);
    });

    // Empty cells for offset
    for(let i=0; i<startOffset; i++) {
        calContainer.appendChild(document.createElement('div'));
    }
    
    // Actual Days
    for(let i=1; i<=numDays; i++) {
        // Construct YYYY-MM-DD for checking
        // Month is 0-indexed in JS Date, but we need 01-12 for string
        const currentCheck = new Date(calDate.getFullYear(), calDate.getMonth(), i);
        // Adjust for timezone offset to ensure string match is correct for local
        // Safer to just build string manually to avoid timezone shifts
        const y = currentCheck.getFullYear();
        const m = String(currentCheck.getMonth()+1).padStart(2,'0');
        const d = String(currentCheck.getDate()).padStart(2,'0');
        const dateStr = `${y}-${m}-${d}`;
        
        const isCompleted = completedDates.has(dateStr);
        
        const dayEl = document.createElement('div');
        dayEl.style.aspectRatio = '1';
        dayEl.style.borderRadius = '4px';
        dayEl.style.fontSize = '0.8rem';
        dayEl.style.display = 'flex';
        dayEl.style.alignItems = 'center';
        dayEl.style.justifyContent = 'center';
        dayEl.style.cursor = 'default';
        
        if (isCompleted) {
             dayEl.style.background = 'var(--success)';
             dayEl.style.color = 'white';
        } else {
             // Check if today
             const today = new Date();
             if (today.toDateString() === currentCheck.toDateString()) {
                 dayEl.style.border = '2px solid var(--primary)';
                 dayEl.style.fontWeight = 'bold';
             }
        }
        
        dayEl.textContent = i;
        calContainer.appendChild(dayEl);
    }
}

function showWeekDetail(week) {
    document.getElementById('summary-dashboard').style.display = 'none';
    document.getElementById('dashboard-title').textContent = 'Week ' + week + ' Breakdown';
    const detailView = document.getElementById('week-detail-view');
    detailView.style.display = 'block';
    
    const list = document.getElementById('week-days-list');
    list.innerHTML = '';
    
    for(let d=1; d<=7; d++) {
        const dayItem = document.createElement('div');
        dayItem.className = 'exercise-card';
        dayItem.style.marginBottom = '10px';
        dayItem.style.cursor = 'pointer';
        dayItem.onclick = () => {
            currentWeek = week;
            currentDay = d;
            navigateTo('workout');
        };
        
        // Find focus for this day
        const dayWorkouts = workoutData.filter(i => i.w === week && i.d === d);
        let focusText = 'Rest / Recovery';
        if(dayWorkouts.length > 0) {
            focusText = dayWorkouts[0].focus;
        }

        // Calculate completion for this day
        let totalSets = 0;
        let doneSets = 0;
        // We need to re-scan for sets for this specific day
        // Logic similar to summary but filtered by day
         const dayIdx={};
         dayWorkouts.forEach(item=>{
            const k=`${item.w}-${item.d}`;
            if(dayIdx[k]===undefined) dayIdx[k]=0;
            const idx=dayIdx[k]++;
            const uid=`w${item.w}-d${item.d}-i${idx}`;
            const sets = getSets(uid, item.defaultSets, item.defaultReps, item.defaultLoad);
            sets.forEach(s => {
                totalSets++;
                if(s.done) doneSets++;
            });
         });
         
        const isDayDone = totalSets > 0 && totalSets === doneSets;
        
        dayItem.innerHTML = `
            <div style="display:flex;justify-content:space-between;align-items:center;">
                <div>
                    <div style="font-weight:bold;">${getDayName(d)}</div>
                    <div style="color:#64748b;font-size:0.9rem;">${focusText}</div>
                </div>
                <div>
                   ${isDayDone ? '<span style="color:var(--success);font-weight:bold;">‚úî Complete</span>' : '<span style="color:#94a3b8;">View ‚Üí</span>'}
                </div>
            </div>
        `;
        list.appendChild(dayItem);
    }
}

function toggleProgramOverview() {
    const content = document.getElementById('program-overview-content');
    const arrow = document.getElementById('overview-arrow');
    if(content.style.display === 'none') {
        content.style.display = 'block';
        arrow.textContent = '‚ñ≤';
        renderOverview();
    } else {
        content.style.display = 'none';
        arrow.textContent = '‚ñº';
    }
}

function toggleStrengthOverview() {
    const content = document.getElementById('strength-overview-content');
    const arrow = document.getElementById('strength-arrow');
    if(content.style.display === 'none') {
        content.style.display = 'block';
        arrow.textContent = '‚ñ≤';
        renderStrengthOverview();
    } else {
        content.style.display = 'none';
        arrow.textContent = '‚ñº';
    }
}

function toggleNutritionOverview() {
    const content = document.getElementById('nutrition-overview-content');
    const arrow = document.getElementById('nutrition-arrow');
    if(content.style.display === 'none') {
        content.style.display = 'block';
        arrow.textContent = '‚ñ≤';
        renderNutritionOverview();
    } else {
        content.style.display = 'none';
        arrow.textContent = '‚ñº';
    }
}

function renderStrengthOverview() {
    const container = document.getElementById('strength-overview-content');
    if(container.innerHTML !== '') return;
    
    container.innerHTML = `
        <div style="margin-bottom:15px;">
            <div style="font-weight:bold;color:var(--primary);">Weekly Structure</div>
            <ul style="margin:5px 0 15px 20px;padding:0;color:var(--text);font-size:0.9rem;">
                <li><strong>Day 1 (Mon): Upper Strength + Posture</strong> (Bench, Pull-ups, Rows, OHP + posture/core)</li>
                <li><strong>Day 2 (Tue): Ruck</strong> (short/threshold/pace work)</li>
                <li><strong>Day 3 (Wed): Lower Strength + Core</strong> (Front squat, Trap-bar DL, lunges, hip thrust, planks)</li>
                <li><strong>Day 4 (Thu): Upper Hypertrophy + Posture</strong> (DB presses/rows + shoulders/arms + posture)</li>
                <li><strong>Day 5 (Fri): Long Ruck</strong> (progressively longer; practice pacing + fueling)</li>
                <li><strong>Day 6 (Sat): Full Body + Optional Easy Ruck</strong> (moderate, crisp reps)</li>
                <li><strong>Day 7 (Sun): Recovery</strong> (easy walk + stretching)</li>
            </ul>
            
            <div style="font-weight:bold;color:var(--primary);">Progression Guidelines</div>
            <ul style="margin:5px 0 0 20px;padding:0;color:var(--text);font-size:0.9rem;">
                <li><strong>Main Lifts:</strong> Use the listed weekly targets as your guide; keep 1‚Äì2 reps in reserve most weeks and prioritize pristine form.</li>
                <li><strong>DB/Accessory Work:</strong> Add load only if all sets are solid and you‚Äôre recovering well; avoid failure (especially Weeks 4‚Äì7).</li>
                <li><strong>Rucks:</strong> Hit the prescribed distance/pace ranges; keep posture tall and stride efficient. Practice hydration/nutrition on long rucks.</li>
                <li><strong>Taper:</strong> Week 8 is a deload/taper‚Äîreduce fatigue, keep movement quality high.</li>
            </ul>
        </div>
    `;
}

function renderNutritionOverview() {
    const container = document.getElementById('nutrition-overview-content');
    if(container.innerHTML !== '') return;
    
    const bw = localStorage.getItem('userBodyweight') || 'your bodyweight';
    
    container.innerHTML = `
        <div style="margin-bottom:15px;">
            <div style="font-weight:bold;color:var(--primary);">Performance Fueling</div>
            <ul style="margin:5px 0 15px 20px;padding:0;color:var(--text);font-size:0.9rem;">
                <li><strong>Protein:</strong> Priority #1 for recovery. Aim for ~1g per lb of bodyweight (approx. ${bw}g/day).</li>
                <li><strong>Hydration:</strong> Drink 3-4 liters of water daily. Add electrolytes for ruck days over 1 hour.</li>
                <li><strong>Carbohydrates:</strong> Fuel for rucking. Eat a complex carb meal 2-3 hours before long rucks.</li>
            </ul>
            
            <div style="font-weight:bold;color:var(--primary);">Recovery</div>
            <div style="font-size:0.9rem;color:var(--text);">Sleep 7-9 hours. Active recovery (mobility/walking) on rest days helps flush metabolic waste.</div>
        </div>
    `;
}

function renderOverview() {
    const container = document.getElementById('program-overview-content');
    if(container.innerHTML !== '') return; // Already rendered
    
    let html = '';
    
    // Group by week
    for(let w=1; w<=8; w++) {
        const weekWorkouts = workoutData.filter(i => i.w === w);
        // Find ruck distances (Tue = Day 2, Fri = Day 5, optional Sat = Day 6)
        const ruckTue = weekWorkouts.find(i => i.d === 2 && i.ex === "Ruck March");
        const ruckFri = weekWorkouts.find(i => i.d === 5 && i.ex === "Ruck March");
        const ruckSatOpt = weekWorkouts.find(i => i.d === 6 && i.ex === "Ruck March" && (i.focus || "").toLowerCase().includes("optional"));
        
        let ruckDesc = 'Focus: Build Base';
        if(ruckTue && ruckFri) {
            ruckDesc = `Rucks: ${ruckTue.defaultReps} (Tue) ‚Ä¢ ${ruckFri.defaultReps} (Fri)`;
            if (ruckSatOpt) {
                ruckDesc += ` ‚Ä¢ Optional: ${ruckSatOpt.defaultReps} (Sat)`;
            }
        }
        
        html += `<div style="margin-bottom:15px;border-bottom:1px solid var(--border);padding-bottom:10px;">
            <div style="font-weight:bold;color:var(--primary);margin-bottom:5px;">Week ${w}</div>
            <div style="font-size:0.9rem;color:var(--text);">${ruckDesc}</div>
            <div style="font-size:0.8rem;color:#64748b;margin-top:2px;">Strength: 4x sessions ‚Ä¢ Rucks: 2x (+ optional) ‚Ä¢ Recovery: Sun</div>
        </div>`;
    }
    
    container.innerHTML = html;
}

function showDashboardOverview() {
    document.getElementById('summary-dashboard').style.display = 'grid';
    document.getElementById('dashboard-title').textContent = 'Weekly Progress';
    document.getElementById('week-detail-view').style.display = 'none';
}

function renderWorkout(){
    const container=document.getElementById('workout-container');
    container.innerHTML='';
    document.getElementById('week-selector').value=currentWeek;
    document.getElementById('current-date-display').textContent=`Week ${currentWeek} ‚Ä¢ ${getDayName(currentDay)}`;
    
    const daysExercises=workoutData.filter(i=>i.w===currentWeek&&i.d===currentDay);
    if(daysExercises.length===0){
        container.innerHTML='<div class="empty-state">No workout scheduled.</div>';
        return;
    }
    
    daysExercises.forEach((ex,index)=>{
        const uid=`w${currentWeek}-d${currentDay}-i${index}`;
        const sets=getSets(uid, ex.defaultSets, ex.defaultReps, ex.defaultLoad);
        // Use saved note if exists, otherwise default note if available
        let savedNote=localStorage.getItem(uid+'_note');
        if (savedNote === null && ex.defaultNote) {
            savedNote = ex.defaultNote;
            // Optionally auto-save this default note so user can edit it
            localStorage.setItem(uid+'_note', savedNote);
        }
        savedNote = savedNote || '';
        
        const card=document.createElement('div');
        card.className='exercise-card';
        card.id='card-'+uid;
        
        // Find previous log
        const lastLog = getLastLog(ex.ex, currentWeek, currentDay);
        
        let setsHtml = '';
        sets.forEach((s, sIdx) => {
            let prevLabel = '';
            if (lastLog && lastLog[sIdx]) {
                const prevLoad = lastLog[sIdx].load;
                // Only show if it's not the default placeholder
                if (prevLoad && prevLoad !== '-') {
                    prevLabel = `<div class="prev-val" onclick="updateSet('${uid}', ${sIdx}, 'load', '${prevLoad}')" title="Copy previous load">Prev: ${prevLoad}</div>`;
                }
            }
            
            setsHtml += `<div class="set-row" style="display:flex;gap:10px;margin-bottom:8px;align-items:center;">
                <div style="width:30px;text-align:center;font-weight:bold;color:#64748b;">${sIdx+1}</div>
                <input type="text" id="input-reps-${uid}-${sIdx}" value="${s.reps}" placeholder="Reps" onchange="updateSet('${uid}',${sIdx},'reps',this.value)" style="width:80px;">
                <input type="text" id="input-load-${uid}-${sIdx}" value="${s.load}" placeholder="Load" onchange="updateSet('${uid}',${sIdx},'load',this.value)" style="flex:1;min-width:60px;">
                ${prevLabel}
                <input type="checkbox" ${s.done?'checked':''} onchange="updateSet('${uid}',${sIdx},'done',this.checked)" style="width:24px;height:24px;">
                <button onclick="deleteSet('${uid}',${sIdx})" style="background:#ef4444;color:white;border:none;border-radius:4px;width:24px;height:24px;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:16px;line-height:1;">√ó</button>
            </div>`;
        });
        
        card.innerHTML=`<div class="exercise-header"><div><div class="exercise-name">${ex.ex}</div></div></div>
        <div id="sets-${uid}">${setsHtml}</div>
        <button onclick="addSet('${uid}')" style="background:var(--primary);color:white;border:none;padding:6px 12px;border-radius:4px;font-size:0.9rem;cursor:pointer;margin-bottom:10px;display:inline-block;">+ Add Set</button>
        <div class="input-group"><input type="text" placeholder="Notes" value="${savedNote}" oninput="saveNote('${uid}',this.value)"></div>`;
        container.appendChild(card);
    });
    updateSummary();
}

function getCurrentSetsState(uid) {
    let sets = [];
    const saved = localStorage.getItem(uid + '_sets');
    if (saved) {
        sets = JSON.parse(saved);
    } else {
         const ex = getExerciseFromUid(uid);
         if (ex) {
            sets = getSets(uid, ex.defaultSets, ex.defaultReps, ex.defaultLoad);
         }
    }
    return sets;
}

function updateSet(uid, setIdx, field, value) {
    try {
        const sets = getCurrentSetsState(uid);
        if (sets[setIdx]) {
            sets[setIdx][field] = value;
            localStorage.setItem(uid + '_sets', JSON.stringify(sets));
            
            // Check if day is complete and log date
            checkAndLogDayCompletion(uid);
            
            // Optimization: Don't re-render entire workout for text inputs to preserve focus
            if (field === 'done') {
                 renderWorkout();
            } else {
                // Manually update the DOM element if it exists (handles "copy previous" clicks)
                // where the DOM hasn't been updated by user typing
                const inputId = `input-${field}-${uid}-${setIdx}`;
                const el = document.getElementById(inputId);
                if(el) el.value = value;
                
                updateSummary();
            }
        }
    } catch (e) {
        alert("Error updating set: " + e.message);
    }
}

function checkAndLogDayCompletion(uid) {
    // Parse uid to get week and day
    const parts = uid.split('-'); 
    const w = parseInt(parts[0].substring(1));
    const d = parseInt(parts[1].substring(1));
    
    // Check all exercises for this day
    let allDone = true;
    
    // We need to know the index of each exercise to generate UID
    // Let's filter workoutData to get exactly the items for this day in order
    const dayItems = workoutData.filter(item => item.w === w && item.d === d);
    
    dayItems.forEach((item, index) => {
        const itemUid = `w${w}-d${d}-i${index}`;
        const sets = getSets(itemUid, item.defaultSets, item.defaultReps, item.defaultLoad);
        // If no sets (deleted all), consider incomplete to avoid false positives
        if (sets.length === 0) {
            allDone = false;
        } else {
            const isItemDone = sets.every(s => s.done);
            if (!isItemDone) allDone = false;
        }
    });

    const completionKey = `completion_date_w${w}_d${d}`;
    if (allDone) {
        // Only set if not already set
        if (!localStorage.getItem(completionKey)) {
            const now = new Date();
            const y = now.getFullYear();
            const m = String(now.getMonth() + 1).padStart(2, '0');
            const dStr = String(now.getDate()).padStart(2, '0');
            const today = `${y}-${m}-${dStr}`;
            localStorage.setItem(completionKey, today);
        }
    } else {
        // If they uncheck something, remove the completion date
        localStorage.removeItem(completionKey);
    }
}

function addSet(uid) {
    try {
        const sets = getCurrentSetsState(uid);
        const last = sets[sets.length-1];
        sets.push({ reps: last ? last.reps : '-', load: last ? last.load : '-', done: false });
        localStorage.setItem(uid + '_sets', JSON.stringify(sets));
        renderWorkout();
    } catch (e) {
        alert("Error adding set: " + e.message);
    }
}

function deleteSet(uid, setIdx) {
    try {
        const sets = getCurrentSetsState(uid);
        if (setIdx >= 0 && setIdx < sets.length) {
            sets.splice(setIdx, 1);
            localStorage.setItem(uid + '_sets', JSON.stringify(sets));
            renderWorkout();
        }
    } catch (e) {
        alert("Error deleting set: " + e.message);
    }
}

function saveNote(id,text){localStorage.setItem(id+'_note',text);}
function getDayName(d){
    // Calculate total day number based on current week
    const totalDay = ((currentWeek - 1) * 7) + d;
    return "Day " + totalDay;
}
function parseLocal(s){const p=s.split('-');return new Date(p[0],p[1]-1,p[2]);}
function calculateCurrentDay(){const today=new Date();today.setHours(0,0,0,0);const diffTime=today-startDate;let diffDays=Math.floor(diffTime/(1000*60*60*24));if(diffDays<0)diffDays=0;currentWeek=Math.floor(diffDays/7)+1;currentDay=(diffDays%7)+1;if(currentWeek>8)currentWeek=8;if(currentWeek<1)currentWeek=1;}
function jumpToToday(){calculateCurrentDay();renderWorkout();}
function changeDay(offset){currentDay+=offset;if(currentDay>7){currentDay=1;currentWeek++;}else if(currentDay<1){currentDay=7;currentWeek--;}if(currentWeek>8){currentWeek=8;currentDay=7;}if(currentWeek<1){currentWeek=1;currentDay=1;}renderWorkout();}

// Timer Logic
let timerInterval = null;
let timerStartTime = 0;
let timerRunning = false;
let timerPausedTime = 0; // Accumulated time when paused

function toggleTimer() {
    const btn = document.getElementById('timer-btn-toggle');
    if (timerRunning) {
        // Pause
        clearInterval(timerInterval);
        timerRunning = false;
        
        // Save current accumulated time
        const elapsed = Math.floor((Date.now() - timerStartTime) / 1000);
        timerPausedTime += elapsed;
        
        // Clear saved start time (state is now paused with accumulated time)
        localStorage.removeItem('timerStartTime');
        localStorage.setItem('timerPausedTime', timerPausedTime);
        
        if(btn) {
            btn.textContent = 'Start';
            btn.style.background = 'var(--primary)';
        }
    } else {
        // Start/Resume
        timerStartTime = Date.now();
        localStorage.setItem('timerStartTime', timerStartTime);
        
        // If we have paused time, keep it in storage? No, we just add it to display
        // Actually, easiest way to track total elapsed is:
        // Total = (Current - Start) + Paused
        
        timerInterval = setInterval(updateTimerDisplay, 1000);
        timerRunning = true;
        
        if(btn) {
            btn.textContent = 'Pause';
            btn.style.background = '#f59e0b'; // Amber
        }
    }
}

function resetTimer() {
    clearInterval(timerInterval);
    timerRunning = false;
    timerPausedTime = 0;
    localStorage.removeItem('timerStartTime');
    localStorage.removeItem('timerPausedTime');
    updateTimerDisplay(true); // Force 00:00
    
    const btn = document.getElementById('timer-btn-toggle');
    if(btn) {
        btn.textContent = 'Start';
        btn.style.background = 'var(--primary)';
    }
}

function updateTimerDisplay(reset = false) {
    const display = document.getElementById('timer-display');
    if (!display) return;
    
    let totalSeconds = 0;
    
    if (reset) {
        totalSeconds = 0;
    } else if (timerRunning) {
        const currentElapsed = Math.floor((Date.now() - timerStartTime) / 1000);
        totalSeconds = currentElapsed + timerPausedTime;
    } else {
        totalSeconds = timerPausedTime;
    }
    
    const hrs = Math.floor(totalSeconds / 3600);
    const mins = Math.floor((totalSeconds % 3600) / 60);
    const secs = totalSeconds % 60;
    
    let text = '';
    if (hrs > 0) {
        text += String(hrs).padStart(2, '0') + ':';
    }
    text += String(mins).padStart(2, '0') + ':' + String(secs).padStart(2, '0');
    display.textContent = text;
}

function initTimerState() {
    const savedStart = localStorage.getItem('timerStartTime');
    const savedPaused = localStorage.getItem('timerPausedTime');
    
    if (savedPaused) {
        timerPausedTime = parseInt(savedPaused);
    }
    
    if (savedStart) {
        // It was running when left/reloaded
        timerStartTime = parseInt(savedStart);
        timerRunning = true;
        timerInterval = setInterval(updateTimerDisplay, 1000);
        
        // Update UI immediately
        const btn = document.getElementById('timer-btn-toggle');
        if(btn) {
            btn.textContent = 'Pause';
            btn.style.background = '#f59e0b';
        }
    } else if (savedPaused) {
        // It was paused
        updateTimerDisplay();
    }
}

window.onload=function(){
    // ... existing onload code ...
    // Call initTimerState() at end

    const savedStart=localStorage.getItem('ruckStartDate');
    const datePicker=document.getElementById('start-date-picker');
    
    // Set user name input
    const savedName = localStorage.getItem('userName');
    if(savedName) document.getElementById('user-name-input').value = savedName;
    
    // Set bodyweight input
    const savedBW = localStorage.getItem('userBodyweight');
    if(savedBW) document.getElementById('user-bw-input').value = savedBW;
    
    // Set gender input
    const savedGender = localStorage.getItem('userGender') || 'male';
    const genderSelect = document.getElementById('user-gender-select');
    if(genderSelect) genderSelect.value = savedGender;
    
    if(savedStart){
        startDate=parseLocal(savedStart);
        datePicker.value=savedStart;
    }else{
        const now=new Date();
        const y=now.getFullYear(),m=String(now.getMonth()+1).padStart(2,'0'),d=String(now.getDate()).padStart(2,'0');
        const str=`${y}-${m}-${d}`;
        datePicker.value=str;
        localStorage.setItem('ruckStartDate',str);
        startDate=parseLocal(str);
    }
    
    calculateCurrentDay();
    renderWorkout();
    
    // Initialize Dashboard as default view
    // But we need to make sure summary is updated
    navigateTo('dashboard');
    
    // Show Greeting
    showGreeting();
    
    if('serviceWorker' in navigator){
        navigator.serviceWorker.register('service-worker.js');
    }
    
    initTimerState();
};
document.getElementById('start-date-picker').addEventListener('change',function(e){localStorage.setItem('ruckStartDate',e.target.value);startDate=parseLocal(e.target.value);calculateCurrentDay();renderWorkout();});
document.getElementById('week-selector').addEventListener('change',function(e){currentWeek=parseInt(e.target.value);currentDay=1;renderWorkout();});
</script>
</body>
</html>

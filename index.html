<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>8-Week Ruck & Strength Tracker</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
manifest.json
<style>
:root { --primary:#2563eb; --bg:#f8fafc; --card:#fff; --text:#1e293b; --border:#e2e8f0; --success:#10b981; }
body[data-theme="dark"] { --bg:#0f172a; --card:#1e293b; --text:#f8fafc; --border:#334155; }
body { font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif; background-color:var(--bg); color:var(--text); margin:0; padding:0; padding-bottom:80px; }
header { background:var(--primary); color:white; padding:1rem; position:sticky; top:0; z-index:100; display:flex; justify-content:space-between; align-items:center; }
button.toggle-theme { background:white; color:var(--primary); border:none; padding:6px 12px; border-radius:6px; font-weight:600; cursor:pointer; }
.view-container { display:none; max-width:600px; margin:0 auto; padding:1rem; }
.view-container.active { display:block; }
.home-grid { display:grid; grid-template-columns:1fr 1fr; gap:15px; margin-top:20px; }
.home-btn { background:var(--card); border:1px solid var(--border); padding:2rem; border-radius:12px; text-align:center; font-weight:700; font-size:1.1rem; cursor:pointer; box-shadow:0 1px 3px rgba(0,0,0,0.05); color:var(--text); transition:transform 0.1s; }
.home-btn:active { transform:scale(0.98); }
.controls { padding:1rem; display:flex; gap:10px; justify-content:space-between; align-items:center; background:white; border-bottom:1px solid var(--border); margin-bottom:1rem; }
select,input[type="date"] { padding:8px; border:1px solid var(--border); border-radius:6px; font-size:14px; }
.summary-dashboard { display:grid; grid-template-columns:repeat(4,1fr); gap:10px; margin-bottom:15px; }
.summary-card { background:var(--card); border:1px solid var(--border); border-radius:8px; padding:8px; text-align:center; font-size:0.8rem; color:var(--text); }
.summary-progress { height:6px; background:#e2e8f0; border-radius:3px; overflow:hidden; margin-top:4px; }
.summary-fill { height:100%; background:var(--success); width:0%; }
.exercise-card { background:var(--card); border-radius:12px; padding:1rem; margin-bottom:1rem; box-shadow:0 1px 3px rgba(0,0,0,0.05); border:1px solid var(--border); color:var(--text); }
.exercise-card.completed { border-left:5px solid var(--success); background:#f0fdf4; }
body[data-theme="dark"] .exercise-card.completed { background: #064e3b; }
.exercise-header { display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:0.5rem; }
.exercise-name { font-weight:700; font-size:1.1rem; }
.input-group { margin-top:10px; display:flex; gap:10px; }
input[type="text"] { width:100%; padding:8px; border:1px solid var(--border); border-radius:6px; font-size:14px; background:var(--bg); color:var(--text); }
.nav-bar { position:fixed; bottom:0; left:0; right:0; background:var(--card); border-top:1px solid var(--border); padding:10px; display:flex; justify-content:space-around; z-index:200; }
button.nav-btn { background:transparent; color:var(--text); border:none; padding:8px; font-size:0.8rem; display:flex; flex-direction:column; align-items:center; cursor:pointer; }
button.nav-btn.active { color:var(--primary); font-weight:bold; }
.back-btn { background:none; border:none; color:white; font-size:1.2rem; cursor:pointer; margin-right:10px; padding: 10px; }

/* Mobile Optimizations */
@media (min-width: 600px) {
    .charts-grid { grid-template-columns: 1fr 1fr; }
}
@media (max-width: 599px) {
    .charts-grid { grid-template-columns: 1fr; }
    .home-grid { grid-template-columns: 1fr; }
    .summary-dashboard { grid-template-columns: repeat(4, 1fr); }
    /* Ensure inputs don't zoom on iOS */
    select, input[type="text"], input[type="date"] { font-size: 16px !important; }
}
</style>
</head>
<body>

<header>
    <div style="display:flex;align-items:center;">
        <button id="header-back-btn" class="back-btn" onclick="navigateTo('home')" style="display:none;">‚Üê</button>
        <h1 id="app-title" style="font-size:1.2rem;margin:0;">Training Tracker</h1>
    </div>
</header>

<div id="view-home" class="view-container">
    <div class="home-grid">
        <div class="home-btn" onclick="navigateTo('workout')">üèãÔ∏è Workout</div>
        <div class="home-btn" onclick="navigateTo('analytics')">üìä Analytics</div>
        <div class="home-btn" onclick="navigateTo('dashboard')">üìà Dashboard</div>
        <div class="home-btn" onclick="navigateTo('settings')">‚öôÔ∏è Settings</div>
    </div>
</div>

<div id="view-workout" class="view-container">
    <div class="controls">
        <div><label style="font-size:0.8rem;color:#64748b">Start Date:</label><input type="date" id="start-date-picker"></div>
        <div><label style="font-size:0.8rem;color:#64748b">Jump to:</label><select id="week-selector"><option value="1">Week 1</option><option value="2">Week 2</option><option value="3">Week 3</option><option value="4">Week 4</option><option value="5">Week 5</option><option value="6">Week 6</option><option value="7">Week 7</option><option value="8">Week 8</option></select></div>
    </div>
    <div class="subtitle" id="current-date-display" style="text-align:center;margin-bottom:1rem;font-weight:600;color:var(--text);">Today</div>
    <div id="workout-container"></div>
    <div style="display:flex;justify-content:space-between;margin-top:20px;">
        <button class="nav-btn" onclick="changeDay(-1)" style="background:var(--primary);color:white;border-radius:8px;padding:10px 20px;">‚Üê Prev</button>
        <button class="nav-btn" onclick="jumpToToday()" style="background:var(--primary);color:white;border-radius:8px;padding:10px 20px;">Today</button>
        <button class="nav-btn" onclick="changeDay(1)" style="background:var(--primary);color:white;border-radius:8px;padding:10px 20px;">Next ‚Üí</button>
    </div>
</div>

<div id="view-analytics" class="view-container">
    <h2>Analytics</h2>
    <div id="analytics-content"></div>
</div>

<div id="view-dashboard" class="view-container">
    <h2 id="dashboard-title">Weekly Progress</h2>
    <div class="summary-dashboard" id="summary-dashboard"></div>
    <div id="week-detail-view" style="display:none;">
        <button onclick="showDashboardOverview()" style="margin-bottom:15px;background:none;border:none;color:var(--primary);cursor:pointer;font-size:1rem;">‚Üê Back to Weeks</button>
        <div id="week-days-list"></div>
    </div>
    
    <h3 style="margin-top:30px;">Activity Calendar</h3>
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
        <button onclick="changeCalendarMonth(-1)" style="background:none;border:none;cursor:pointer;font-size:1.2rem;color:var(--text);">‚Üê</button>
        <span id="calendar-month-year" style="font-weight:bold;font-size:0.9rem;"></span>
        <button onclick="changeCalendarMonth(1)" style="background:none;border:none;cursor:pointer;font-size:1.2rem;color:var(--text);">‚Üí</button>
    </div>
    <div id="activity-calendar" style="display:grid;grid-template-columns:repeat(7, 1fr);gap:4px;"></div>
</div>

<div id="view-settings" class="view-container">
    <h2>Settings</h2>
    <div style="margin-bottom:20px;">
        <label style="display:block;margin-bottom:5px;font-weight:bold;">Your Name</label>
        <input type="text" id="user-name-input" placeholder="Enter your name" oninput="saveUserName(this.value)" style="width:100%;padding:10px;font-size:1rem;">
    </div>
    <div style="margin-bottom:20px;">
        <label style="display:block;margin-bottom:5px;font-weight:bold;">Bodyweight (lbs)</label>
        <input type="number" id="user-bw-input" placeholder="e.g. 185" oninput="saveBodyweight(this.value)" style="width:100%;padding:10px;font-size:1rem;">
    </div>
    <div style="margin-bottom:20px;">
        <label style="display:block;margin-bottom:5px;font-weight:bold;">Gender</label>
        <select id="user-gender-select" onchange="saveGender(this.value)" style="width:100%;padding:10px;font-size:1rem;">
            <option value="male">Male</option>
            <option value="female">Female</option>
        </select>
    </div>
    <div class="home-btn" onclick="toggleTheme()" style="margin-bottom:10px;">Toggle Dark Mode</div>
    <div class="home-btn" onclick="exportNotes()" style="margin-bottom:10px;">Export Notes</div>
    <div class="home-btn" onclick="resetData()" style="background:#ef4444;color:white;margin-top:20px;">‚ö†Ô∏è Reset All Data</div>
</div>

<script>
// Full workoutData array (all 8 weeks)
const workoutData = [];
(function generate() {
    const upper = [
        {ex:"Bench Press",set:"4",rep:"5‚Äì8",load:"180 lb"},
        {ex:"Pull-ups",set:"4",rep:"4‚Äì8",load:"BW"},
        {ex:"BB Row",set:"4",rep:"6‚Äì8",load:"Moderate"},
        {ex:"OHP",set:"3",rep:"6‚Äì8",load:"95 lb"}
    ];
    const lower = [
        {ex:"Back Squat",set:"3",rep:"5",load:"225 lb"},
        {ex:"Deadlift",set:"3",rep:"3",load:"315 lb"},
        {ex:"Lunges",set:"3",rep:"10/leg",load:"40 lb"},
        {ex:"Plank",set:"3",rep:"60s",load:"BW"}
    ];
    const cond = [
        {ex:"Push-ups",set:"5",rep:"20",load:"BW"},
        {ex:"Air Squats",set:"5",rep:"30",load:"BW"},
        {ex:"KB Swings",set:"4",rep:"25",load:"53 lb"},
        {ex:"Ruck Shuffle",set:"1",rep:"1 mile",load:"45 lb"}
    ];

    for(let w=1; w<=8; w++) {
        // Day 1: Upper
        upper.forEach(u => workoutData.push({w, d:1, focus:"Upper Strength", ex:u.ex, defaultSets: parseInt(u.set), defaultReps: u.rep, defaultLoad: u.load}));
        // Day 2: Short Ruck
        workoutData.push({w, d:2, focus:"Ruck (Short)", ex:"Ruck March", defaultSets: 1, defaultReps: `${3 + (w-1)*0.5} miles`, defaultLoad: "30lb"});
        // Day 3: Lower
        lower.forEach(l => workoutData.push({w, d:3, focus:"Lower Strength", ex:l.ex, defaultSets: parseInt(l.set), defaultReps: l.rep, defaultLoad: l.load}));
        // Day 4: Base Ruck
        workoutData.push({w, d:4, focus:"Ruck (Base)", ex:"Ruck March", defaultSets: 1, defaultReps: `${4 + (w-1)*0.5} miles`, defaultLoad: "30lb"});
        // Day 5: Conditioning
        cond.forEach(c => workoutData.push({w, d:5, focus:"Conditioning", ex:c.ex, defaultSets: parseInt(c.set), defaultReps: c.rep, defaultLoad: c.load}));
        // Day 6: Long Ruck
        workoutData.push({w, d:6, focus:"Ruck (Long)", ex:"Ruck March", defaultSets: 1, defaultReps: `${6 + w} miles`, defaultLoad: "30-45lb"});
        // Day 7: Rest
        workoutData.push({w, d:7, focus:"Recovery", ex:"Mobility / Rest", defaultSets: 1, defaultReps: "30 min", defaultLoad: "-"});
    }
})();

// Helper to find exercise data from UID
function getExerciseFromUid(uid) {
    try {
        const parts = uid.split('-'); // w1-d1-i0
        const w = parseInt(parts[0].substring(1));
        const d = parseInt(parts[1].substring(1));
        const i = parseInt(parts[2].substring(1));
        const daysExercises = workoutData.filter(item => item.w === w && item.d === d);
        return daysExercises[i];
    } catch(e) {
        console.error("Error parsing UID", uid, e);
        return null;
    }
}

function getSets(uid, defaultSets, defaultReps, defaultLoad) {
    try {
        const saved = localStorage.getItem(uid + '_sets');
        if (saved) return JSON.parse(saved);
    } catch (e) {
        console.error("Error reading sets from LS", e);
    }
    
    // Generate defaults
    const sets = [];
    const count = defaultSets || 1; 
    for (let i = 0; i < count; i++) {
        sets.push({ reps: defaultReps || '-', load: defaultLoad || '-', done: false });
    }
    return sets;
}

// Navigation Logic
function navigateTo(view) {
    document.querySelectorAll('.view-container').forEach(el => el.classList.remove('active'));
    document.getElementById('view-' + view).classList.add('active');
    
    const backBtn = document.getElementById('header-back-btn');
    const titleEl = document.getElementById('app-title');
    const name = localStorage.getItem('userName');
    
    if (view === 'home') {
        backBtn.style.display = 'none';
        titleEl.textContent = 'Training Tracker';
    } else {
        backBtn.style.display = 'block';
        let viewName = view.charAt(0).toUpperCase() + view.slice(1);
        if (view === 'dashboard' && name) {
            viewName = `${name}'s Dashboard`;
        }
        titleEl.textContent = viewName;
    }

    if (view === 'workout') {
        renderWorkout();
    } else if (view === 'dashboard') {
        showDashboardOverview(); // Reset to overview when entering dashboard
        updateSummary();
    } else if (view === 'analytics') {
        renderAnalytics();
    }
}

// Analytics Logic
function renderAnalytics() {
    const container = document.getElementById('analytics-content');
    container.innerHTML = '';
    
    // Create canvas elements
    const lifts = ['Bench Press', 'Back Squat', 'Deadlift', 'OHP'];
    
    // Container for lift charts
    const liftsContainer = document.createElement('div');
    liftsContainer.className = 'charts-grid';
    liftsContainer.style.display = 'grid';
    liftsContainer.style.gap = '10px';
    
    lifts.forEach(lift => {
        const wrapper = document.createElement('div');
        wrapper.className = 'summary-card';
        wrapper.style.padding = '10px';
        wrapper.innerHTML = `<div style="font-size:0.8rem;font-weight:bold;margin-bottom:5px;">${lift} (Est. 1RM)</div><canvas id="chart-${lift.replace(/\s/g,'')}"></canvas>`;
        liftsContainer.appendChild(wrapper);
    });
    
    // Container for Ruck Chart
    const ruckWrapper = document.createElement('div');
    ruckWrapper.className = 'summary-card';
    ruckWrapper.style.padding = '10px';
    ruckWrapper.style.marginTop = '15px';
    ruckWrapper.innerHTML = `<div style="font-size:0.9rem;font-weight:bold;margin-bottom:5px;">Rucking Volume (Miles)</div><canvas id="chart-ruck"></canvas>`;
    
    container.appendChild(liftsContainer);
    container.appendChild(ruckWrapper);
    
    // Standards Section
    const bw = parseFloat(localStorage.getItem('userBodyweight'));
    if (!isNaN(bw) && bw > 0) {
        const standardsContainer = document.createElement('div');
        standardsContainer.className = 'summary-card';
        standardsContainer.style.padding = '10px';
        standardsContainer.style.marginTop = '15px';
        
        standardsContainer.innerHTML = `<div style="font-size:0.9rem;font-weight:bold;margin-bottom:5px;">Strength Comparison (vs BW: ${bw}lb)</div>
        <div style="height:300px;"><canvas id="chart-standards"></canvas></div>
        <div style="font-size:0.7rem;color:#64748b;margin-top:5px;text-align:center;">Based on general strength standards multipliers</div>`;
        
        container.appendChild(standardsContainer);
    } else {
        const prompt = document.createElement('div');
        prompt.className = 'summary-card';
        prompt.style.padding = '15px';
        prompt.style.marginTop = '15px';
        prompt.style.textAlign = 'center';
        prompt.innerHTML = `<p>Enter your <strong>Bodyweight</strong> in Settings to see Strength Standards comparison.</p>
        <button onclick="navigateTo('settings')" style="background:var(--primary);color:white;border:none;padding:8px 16px;border-radius:6px;cursor:pointer;margin-top:5px;">Go to Settings</button>`;
        container.appendChild(prompt);
    }
    
    // Gather Data
    // We want to track progress over time. Let's group by Week.
    // Structure: { Week1: {Bench: 180, Squat: 225...}, Week2: ... }
    const weeklyMaxes = {};
    const currentMaxes = {}; // Latest best
    const weeklyRuck = {}; // { Week1: 5, Week2: 6... }
    
    for(let w=1; w<=8; w++) {
        weeklyMaxes[w] = {};
        weeklyRuck[w] = 0;
        lifts.forEach(l => weeklyMaxes[w][l] = 0);
    }
    
    lifts.forEach(l => currentMaxes[l] = 0);
    
    workoutData.forEach((item) => {
        // Construct UID
        const daysExercises = workoutData.filter(d => d.w === item.w && d.d === item.d);
        const index = daysExercises.indexOf(item);
        const uid = `w${item.w}-d${item.d}-i${index}`;
        const sets = getSets(uid, item.defaultSets, item.defaultReps, item.defaultLoad);
        
        // Rucking Logic
        if (item.ex === "Ruck March" && item.focus.includes("Ruck")) {
            // Check if done
            const isDone = sets.every(s => s.done);
            if (isDone) {
               // Try to parse miles from reps (e.g., "3 miles")
               // Default reps is string like "3 miles" or "3 + (w-1)..."
               // We need the ACTUAL saved value if edited, or default.
               // sets[0].reps should have it.
               const repStr = sets[0].reps.toLowerCase();
               const miles = parseFloat(repStr);
               if (!isNaN(miles)) {
                   weeklyRuck[item.w] += miles;
               }
            }
        }
        
        // Lift Logic
        if (lifts.includes(item.ex)) {
            sets.forEach(s => {
                if (s.done) {
                    const load = parseFloat(s.load);
                    const reps = parseFloat(s.reps);
                    if (!isNaN(load) && !isNaN(reps) && reps > 0) {
                        const e1rm = load * (1 + reps/30);
                        if (e1rm > weeklyMaxes[item.w][item.ex]) {
                            weeklyMaxes[item.w][item.ex] = e1rm;
                        }
                        if (e1rm > currentMaxes[item.ex]) {
                            currentMaxes[item.ex] = e1rm;
                        }
                    }
                }
            });
        }
    });
    
    // Render Standards Chart if BW exists
    if (!isNaN(bw) && bw > 0) {
        // Multipliers (Approximate male/female standards)
        const gender = localStorage.getItem('userGender') || 'male';
        
        let standards = {};
        
        if (gender === 'female') {
            // Female Standards (approx multipliers)
            standards = {
                'Bench Press': { beg: 0.5, int: 0.75, adv: 1.0 },
                'Back Squat': { beg: 0.75, int: 1.15, adv: 1.5 },
                'Deadlift': { beg: 1.0, int: 1.25, adv: 1.75 },
                'OHP': { beg: 0.35, int: 0.55, adv: 0.75 }
            };
        } else {
            // Male Standards
            standards = {
                'Bench Press': { beg: 0.75, int: 1.15, adv: 1.5 },
                'Back Squat': { beg: 1.0, int: 1.5, adv: 2.0 },
                'Deadlift': { beg: 1.25, int: 1.75, adv: 2.25 },
                'OHP': { beg: 0.5, int: 0.75, adv: 1.0 }
            };
        }
        
        const labels = lifts;
        const userVals = lifts.map(l => Math.round(currentMaxes[l]));
        const begVals = lifts.map(l => Math.round(bw * standards[l].beg));
        const intVals = lifts.map(l => Math.round(bw * standards[l].int));
        const advVals = lifts.map(l => Math.round(bw * standards[l].adv));
        
        new Chart(document.getElementById('chart-standards').getContext('2d'), {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [
                    { label: 'You', data: userVals, backgroundColor: '#2563eb', borderRadius: 4 },
                    { label: 'Beginner', data: begVals, backgroundColor: '#94a3b8', borderRadius: 4, hidden: true },
                    { label: 'Intermediate', data: intVals, backgroundColor: '#fbbf24', borderRadius: 4 },
                    { label: 'Advanced', data: advVals, backgroundColor: '#f87171', borderRadius: 4 }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: { y: { beginAtZero: true, title: {display:true, text:'Weight (lbs)'} } },
                plugins: {
                    legend: { position: 'bottom' },
                    title: { display: true, text: `Standards for ${gender.charAt(0).toUpperCase() + gender.slice(1)}` }
                }
            }
        });
    }
    
    // Render Lift Charts
    const weeksLabel = Array.from({length:8}, (_, i) => `W${i+1}`);
    
    lifts.forEach(lift => {
        const ctx = document.getElementById(`chart-${lift.replace(/\s/g,'')}`).getContext('2d');
        const data = [];
        for(let w=1; w<=8; w++) {
            data.push(weeklyMaxes[w][lift] || 0); // 0 means no data for that week
        }
        
        new Chart(ctx, {
            type: 'bar',
            data: {
                labels: weeksLabel,
                datasets: [{
                    label: '1RM',
                    data: data,
                    backgroundColor: '#2563eb',
                    borderRadius: 4
                }]
            },
            options: {
                responsive: true,
                plugins: { legend: { display: false } },
                scales: {
                    x: { display: true, ticks: {font:{size:10}} },
                    y: { beginAtZero: false, display: true, ticks: {font:{size:10}} }
                }
            }
        });
    });
    
    // Render Ruck Chart
    const ruckCtx = document.getElementById('chart-ruck').getContext('2d');
    const ruckData = [];
    for(let w=1; w<=8; w++) {
        ruckData.push(weeklyRuck[w]);
    }
    
    new Chart(ruckCtx, {
        type: 'line',
        data: {
            labels: weeksLabel,
            datasets: [{
                label: 'Miles',
                data: ruckData,
                borderColor: '#10b981',
                backgroundColor: 'rgba(16, 185, 129, 0.2)',
                fill: true,
                tension: 0.3
            }]
        },
        options: {
            responsive: true,
            plugins: { legend: { display: false } },
            scales: {
                y: { beginAtZero: true }
            }
        }
    });
}

function resetData() {
    if(confirm("Are you sure you want to delete all data? This cannot be undone.")) {
        localStorage.clear();
        location.reload();
    }
}

let currentWeek=1,currentDay=1,startDate=new Date();
function toggleTheme(){const body=document.body;const current=body.getAttribute('data-theme');if(current==='dark'){body.removeAttribute('data-theme');localStorage.setItem('theme','light');}else{body.setAttribute('data-theme','dark');localStorage.setItem('theme','dark');}}
if(localStorage.getItem('theme')==='dark'){document.body.setAttribute('data-theme','dark');}
function exportNotes(){let notes='Workout Notes:\\n';for(let i=0;i<localStorage.length;i++){const key=localStorage.key(i);if(key.endsWith('_note')){notes+=key+': '+localStorage.getItem(key)+'\\n';}}const blob=new Blob([notes],{type:'text/plain'});const url=URL.createObjectURL(blob);const a=document.createElement('a');a.href=url;a.download='ruck_notes.txt';a.click();URL.revokeObjectURL(url);}

function updateSummary(){
    const dashboard=document.getElementById('summary-dashboard');
    dashboard.innerHTML='';
    const counts={};
    for(let w=1;w<=8;w++) counts[w]={total:0,done:0};
    
    const dayIdx={};
    workoutData.forEach(item=>{
        if(item.w<1||item.w>8) return;
        const k=`${item.w}-${item.d}`;
        if(dayIdx[k]===undefined) dayIdx[k]=0;
        const idx=dayIdx[k]++;
        const uid=`w${item.w}-d${item.d}-i${idx}`;
        const sets = getSets(uid, item.defaultSets, item.defaultReps, item.defaultLoad);
        sets.forEach(s => {
            counts[item.w].total++;
            if(s.done) counts[item.w].done++;
        });
    });

    for(let w=1;w<=8;w++){
        const{total,done}=counts[w];
        const percent=total?Math.round((done/total)*100):0;
        const card=document.createElement('div');
        card.className='summary-card';
        card.style.cursor = 'pointer';
        card.onclick = () => showWeekDetail(w);
        card.innerHTML='Week '+w+'<div class="summary-progress"><div class="summary-fill" style="width:'+percent+'%"></div></div>'+percent+'%';
        dashboard.appendChild(card);
    }
    
    renderCalendar();
}

// Quotes
const quotes = [
    "Strength does not come from winning. Your struggles develop your strengths.",
    "The only bad workout is the one that didn't happen.",
    "Don't stop when you're tired. Stop when you're done.",
    "Your body can stand almost anything. It's your mind that you have to convince.",
    "The pain you feel today will be the strength you feel tomorrow.",
    "Discipline is doing what needs to be done, even if you don't want to do it."
];

function showGreeting() {
    const name = localStorage.getItem('userName') || 'Friend';
    const quote = quotes[Math.floor(Math.random() * quotes.length)];
    
    // Create Overlay
    const overlay = document.createElement('div');
    overlay.id = 'greeting-overlay';
    overlay.style.position = 'fixed';
    overlay.style.top = '0';
    overlay.style.left = '0';
    overlay.style.width = '100%';
    overlay.style.height = '100%';
    overlay.style.background = 'var(--bg)';
    overlay.style.color = 'var(--text)';
    overlay.style.zIndex = '1000';
    overlay.style.display = 'flex';
    overlay.style.flexDirection = 'column';
    overlay.style.justifyContent = 'center';
    overlay.style.alignItems = 'center';
    overlay.style.textAlign = 'center';
    overlay.style.padding = '20px';
    overlay.style.transition = 'opacity 0.5s ease';
    
    overlay.innerHTML = `
        <h1 style="font-size:2rem;margin-bottom:20px;">Welcome, ${name}</h1>
        <p style="font-size:1.2rem;font-style:italic;max-width:500px;line-height:1.5;">"${quote}"</p>
        <button onclick="closeGreeting()" style="margin-top:40px;padding:10px 25px;background:var(--primary);color:white;border:none;border-radius:8px;font-size:1rem;cursor:pointer;">Let's Go</button>
    `;
    
    document.body.appendChild(overlay);
}

function closeGreeting() {
    const overlay = document.getElementById('greeting-overlay');
    if(overlay) {
        overlay.style.opacity = '0';
        setTimeout(() => overlay.remove(), 500);
    }
}

function saveUserName(name) {
    localStorage.setItem('userName', name);
    updateHeaderName();
}

function saveBodyweight(bw) {
    localStorage.setItem('userBodyweight', bw);
    // Refresh analytics if view is active
    if(document.getElementById('view-analytics').classList.contains('active')) {
        renderAnalytics();
    }
}

function saveGender(gender) {
    localStorage.setItem('userGender', gender);
    // Refresh analytics if view is active
    if(document.getElementById('view-analytics').classList.contains('active')) {
        renderAnalytics();
    }
}

function updateHeaderName() {
    const name = localStorage.getItem('userName');
    const titleEl = document.getElementById('app-title');
    // Only update if on Dashboard or Home, otherwise keep view title
    // Actually, user asked for name at top of main screen.
    // Let's modify navigateTo to handle title updates dynamiclly.
    if(name && document.getElementById('view-dashboard').classList.contains('active')) {
         titleEl.textContent = `Dashboard - ${name}`;
    }
}

let calDate = new Date();

function changeCalendarMonth(offset) {
    calDate.setMonth(calDate.getMonth() + offset);
    renderCalendar();
}

function renderCalendar() {
    const calContainer = document.getElementById('activity-calendar');
    const headerEl = document.getElementById('calendar-month-year');
    calContainer.innerHTML = '';
    
    // Set Header
    const monthNames = ["January","February","March","April","May","June","July","August","September","October","November","December"];
    headerEl.textContent = `${monthNames[calDate.getMonth()]} ${calDate.getFullYear()}`;
    
    // Calculate Grid
    // First day of current month
    const firstDay = new Date(calDate.getFullYear(), calDate.getMonth(), 1);
    // Number of days in current month
    const lastDay = new Date(calDate.getFullYear(), calDate.getMonth() + 1, 0);
    const numDays = lastDay.getDate();
    
    // Start offset (Day of week: 0=Sun, 1=Mon...)
    // If we want Monday start, we adjust. Let's assume standard Sunday start for calendar grid visualization
    const startOffset = firstDay.getDay(); 
    
    // Find completion dates
    const completedDates = new Set();
    for(let i=0; i<localStorage.length; i++) {
        const key = localStorage.key(i);
        if(key.startsWith('completion_date_')) {
            completedDates.add(localStorage.getItem(key));
        }
    }
    
    // Day Headers (S M T W T F S)
    const dayHeaders = ['S','M','T','W','T','F','S'];
    dayHeaders.forEach(h => {
        const hEl = document.createElement('div');
        hEl.style.textAlign = 'center';
        hEl.style.fontSize = '0.7rem';
        hEl.style.fontWeight = 'bold';
        hEl.style.color = '#64748b';
        hEl.textContent = h;
        calContainer.appendChild(hEl);
    });

    // Empty cells for offset
    for(let i=0; i<startOffset; i++) {
        calContainer.appendChild(document.createElement('div'));
    }
    
    // Actual Days
    for(let i=1; i<=numDays; i++) {
        // Construct YYYY-MM-DD for checking
        // Month is 0-indexed in JS Date, but we need 01-12 for string
        const currentCheck = new Date(calDate.getFullYear(), calDate.getMonth(), i);
        // Adjust for timezone offset to ensure string match is correct for local
        // Safer to just build string manually to avoid timezone shifts
        const y = currentCheck.getFullYear();
        const m = String(currentCheck.getMonth()+1).padStart(2,'0');
        const d = String(currentCheck.getDate()).padStart(2,'0');
        const dateStr = `${y}-${m}-${d}`;
        
        const isCompleted = completedDates.has(dateStr);
        
        const dayEl = document.createElement('div');
        dayEl.style.aspectRatio = '1';
        dayEl.style.borderRadius = '4px';
        dayEl.style.fontSize = '0.8rem';
        dayEl.style.display = 'flex';
        dayEl.style.alignItems = 'center';
        dayEl.style.justifyContent = 'center';
        dayEl.style.cursor = 'default';
        
        if (isCompleted) {
             dayEl.style.background = 'var(--success)';
             dayEl.style.color = 'white';
        } else {
             // Check if today
             const today = new Date();
             if (today.toDateString() === currentCheck.toDateString()) {
                 dayEl.style.border = '2px solid var(--primary)';
                 dayEl.style.fontWeight = 'bold';
             }
        }
        
        dayEl.textContent = i;
        calContainer.appendChild(dayEl);
    }
}

function showWeekDetail(week) {
    document.getElementById('summary-dashboard').style.display = 'none';
    document.getElementById('dashboard-title').textContent = 'Week ' + week + ' Breakdown';
    const detailView = document.getElementById('week-detail-view');
    detailView.style.display = 'block';
    
    const list = document.getElementById('week-days-list');
    list.innerHTML = '';
    
    for(let d=1; d<=7; d++) {
        const dayItem = document.createElement('div');
        dayItem.className = 'exercise-card';
        dayItem.style.marginBottom = '10px';
        dayItem.style.cursor = 'pointer';
        dayItem.onclick = () => {
            currentWeek = week;
            currentDay = d;
            navigateTo('workout');
        };
        
        // Find focus for this day
        const dayWorkouts = workoutData.filter(i => i.w === week && i.d === d);
        let focusText = 'Rest / Recovery';
        if(dayWorkouts.length > 0) {
            focusText = dayWorkouts[0].focus;
        }

        // Calculate completion for this day
        let totalSets = 0;
        let doneSets = 0;
        // We need to re-scan for sets for this specific day
        // Logic similar to summary but filtered by day
         const dayIdx={};
         dayWorkouts.forEach(item=>{
            const k=`${item.w}-${item.d}`;
            if(dayIdx[k]===undefined) dayIdx[k]=0;
            const idx=dayIdx[k]++;
            const uid=`w${item.w}-d${item.d}-i${idx}`;
            const sets = getSets(uid, item.defaultSets, item.defaultReps, item.defaultLoad);
            sets.forEach(s => {
                totalSets++;
                if(s.done) doneSets++;
            });
         });
         
        const isDayDone = totalSets > 0 && totalSets === doneSets;
        
        dayItem.innerHTML = `
            <div style="display:flex;justify-content:space-between;align-items:center;">
                <div>
                    <div style="font-weight:bold;">${getDayName(d)}</div>
                    <div style="color:#64748b;font-size:0.9rem;">${focusText}</div>
                </div>
                <div>
                   ${isDayDone ? '<span style="color:var(--success);font-weight:bold;">‚úî Complete</span>' : '<span style="color:#94a3b8;">View ‚Üí</span>'}
                </div>
            </div>
        `;
        list.appendChild(dayItem);
    }
}

function showDashboardOverview() {
    document.getElementById('summary-dashboard').style.display = 'grid';
    document.getElementById('dashboard-title').textContent = 'Weekly Progress';
    document.getElementById('week-detail-view').style.display = 'none';
}

function renderWorkout(){
    const container=document.getElementById('workout-container');
    container.innerHTML='';
    document.getElementById('week-selector').value=currentWeek;
    document.getElementById('current-date-display').textContent=`Week ${currentWeek} ‚Ä¢ ${getDayName(currentDay)}`;
    
    const daysExercises=workoutData.filter(i=>i.w===currentWeek&&i.d===currentDay);
    if(daysExercises.length===0){
        container.innerHTML='<div class="empty-state">No workout scheduled.</div>';
        return;
    }
    
    daysExercises.forEach((ex,index)=>{
        const uid=`w${currentWeek}-d${currentDay}-i${index}`;
        const sets=getSets(uid, ex.defaultSets, ex.defaultReps, ex.defaultLoad);
        const savedNote=localStorage.getItem(uid+'_note')||'';
        
        const card=document.createElement('div');
        card.className='exercise-card';
        card.id='card-'+uid;
        
        let setsHtml = '';
        sets.forEach((s, sIdx) => {
            setsHtml += `<div class="set-row" style="display:flex;gap:10px;margin-bottom:8px;align-items:center;">
                <div style="width:30px;text-align:center;font-weight:bold;color:#64748b;">${sIdx+1}</div>
                <input type="text" value="${s.reps}" placeholder="Reps" onchange="updateSet('${uid}',${sIdx},'reps',this.value)" style="width:80px;">
                <input type="text" value="${s.load}" placeholder="Load" onchange="updateSet('${uid}',${sIdx},'load',this.value)" style="flex:1;">
                <input type="checkbox" ${s.done?'checked':''} onchange="updateSet('${uid}',${sIdx},'done',this.checked)" style="width:24px;height:24px;">
                <button onclick="deleteSet('${uid}',${sIdx})" style="background:#ef4444;color:white;border:none;border-radius:4px;width:24px;height:24px;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:16px;line-height:1;">√ó</button>
            </div>`;
        });
        
        card.innerHTML=`<div class="exercise-header"><div><div class="exercise-name">${ex.ex}</div></div></div>
        <div id="sets-${uid}">${setsHtml}</div>
        <button onclick="addSet('${uid}')" style="background:var(--primary);color:white;border:none;padding:6px 12px;border-radius:4px;font-size:0.9rem;cursor:pointer;margin-bottom:10px;display:inline-block;">+ Add Set</button>
        <div class="input-group"><input type="text" placeholder="Notes" value="${savedNote}" oninput="saveNote('${uid}',this.value)"></div>`;
        container.appendChild(card);
    });
    updateSummary();
}

function getCurrentSetsState(uid) {
    let sets = [];
    const saved = localStorage.getItem(uid + '_sets');
    if (saved) {
        sets = JSON.parse(saved);
    } else {
         const ex = getExerciseFromUid(uid);
         if (ex) {
            sets = getSets(uid, ex.defaultSets, ex.defaultReps, ex.defaultLoad);
         }
    }
    return sets;
}

function updateSet(uid, setIdx, field, value) {
    try {
        const sets = getCurrentSetsState(uid);
        if (sets[setIdx]) {
            sets[setIdx][field] = value;
            localStorage.setItem(uid + '_sets', JSON.stringify(sets));
            
            // Check if day is complete and log date
            checkAndLogDayCompletion(uid);
            
            renderWorkout();
        }
    } catch (e) {
        alert("Error updating set: " + e.message);
    }
}

function checkAndLogDayCompletion(uid) {
    // Parse uid to get week and day
    const parts = uid.split('-'); 
    const w = parseInt(parts[0].substring(1));
    const d = parseInt(parts[1].substring(1));
    
    // Check all exercises for this day
    let allDone = true;
    
    // We need to know the index of each exercise to generate UID
    // Let's filter workoutData to get exactly the items for this day in order
    const dayItems = workoutData.filter(item => item.w === w && item.d === d);
    
    dayItems.forEach((item, index) => {
        const itemUid = `w${w}-d${d}-i${index}`;
        const sets = getSets(itemUid, item.defaultSets, item.defaultReps, item.defaultLoad);
        // If no sets (deleted all), consider incomplete to avoid false positives
        if (sets.length === 0) {
            allDone = false;
        } else {
            const isItemDone = sets.every(s => s.done);
            if (!isItemDone) allDone = false;
        }
    });

    const completionKey = `completion_date_w${w}_d${d}`;
    if (allDone) {
        // Only set if not already set
        if (!localStorage.getItem(completionKey)) {
            const now = new Date();
            const y = now.getFullYear();
            const m = String(now.getMonth() + 1).padStart(2, '0');
            const dStr = String(now.getDate()).padStart(2, '0');
            const today = `${y}-${m}-${dStr}`;
            localStorage.setItem(completionKey, today);
        }
    } else {
        // If they uncheck something, remove the completion date
        localStorage.removeItem(completionKey);
    }
}

function addSet(uid) {
    try {
        const sets = getCurrentSetsState(uid);
        const last = sets[sets.length-1];
        sets.push({ reps: last ? last.reps : '-', load: last ? last.load : '-', done: false });
        localStorage.setItem(uid + '_sets', JSON.stringify(sets));
        renderWorkout();
    } catch (e) {
        alert("Error adding set: " + e.message);
    }
}

function deleteSet(uid, setIdx) {
    try {
        const sets = getCurrentSetsState(uid);
        if (setIdx >= 0 && setIdx < sets.length) {
            sets.splice(setIdx, 1);
            localStorage.setItem(uid + '_sets', JSON.stringify(sets));
            renderWorkout();
        }
    } catch (e) {
        alert("Error deleting set: " + e.message);
    }
}

function saveNote(id,text){localStorage.setItem(id+'_note',text);}
function getDayName(d){
    // Calculate total day number based on current week
    const totalDay = ((currentWeek - 1) * 7) + d;
    return "Day " + totalDay;
}
function parseLocal(s){const p=s.split('-');return new Date(p[0],p[1]-1,p[2]);}
function calculateCurrentDay(){const today=new Date();today.setHours(0,0,0,0);const diffTime=today-startDate;let diffDays=Math.floor(diffTime/(1000*60*60*24));if(diffDays<0)diffDays=0;currentWeek=Math.floor(diffDays/7)+1;currentDay=(diffDays%7)+1;if(currentWeek>8)currentWeek=8;if(currentWeek<1)currentWeek=1;}
function jumpToToday(){calculateCurrentDay();renderWorkout();}
function changeDay(offset){currentDay+=offset;if(currentDay>7){currentDay=1;currentWeek++;}else if(currentDay<1){currentDay=7;currentWeek--;}if(currentWeek>8){currentWeek=8;currentDay=7;}if(currentWeek<1){currentWeek=1;currentDay=1;}renderWorkout();}
window.onload=function(){
    const savedStart=localStorage.getItem('ruckStartDate');
    const datePicker=document.getElementById('start-date-picker');
    
    // Set user name input
    const savedName = localStorage.getItem('userName');
    if(savedName) document.getElementById('user-name-input').value = savedName;
    
    // Set bodyweight input
    const savedBW = localStorage.getItem('userBodyweight');
    if(savedBW) document.getElementById('user-bw-input').value = savedBW;
    
    // Set gender input
    const savedGender = localStorage.getItem('userGender') || 'male';
    const genderSelect = document.getElementById('user-gender-select');
    if(genderSelect) genderSelect.value = savedGender;
    
    if(savedStart){
        startDate=parseLocal(savedStart);
        datePicker.value=savedStart;
    }else{
        const now=new Date();
        const y=now.getFullYear(),m=String(now.getMonth()+1).padStart(2,'0'),d=String(now.getDate()).padStart(2,'0');
        const str=`${y}-${m}-${d}`;
        datePicker.value=str;
        localStorage.setItem('ruckStartDate',str);
        startDate=parseLocal(str);
    }
    
    calculateCurrentDay();
    renderWorkout();
    
    // Initialize Dashboard as default view
    // But we need to make sure summary is updated
    navigateTo('dashboard');
    
    // Show Greeting
    showGreeting();
    
    if('serviceWorker' in navigator){
        navigator.serviceWorker.register('service-worker.js');
    }
};
document.getElementById('start-date-picker').addEventListener('change',function(e){localStorage.setItem('ruckStartDate',e.target.value);startDate=parseLocal(e.target.value);calculateCurrentDay();renderWorkout();});
document.getElementById('week-selector').addEventListener('change',function(e){currentWeek=parseInt(e.target.value);currentDay=1;renderWorkout();});
</script>
</body>
</html>
